# 框架设计概览

[toc]

## 一、权衡框架设计



#### 运行时、编译时框架

使用一个例子来说明运行时、编译时框架的区别。假设我们给用户提供了这样一个 render 函数，来将符合结构的对象转换为 DOM。

```js
const obj = {
  tag: 'div',
  children: [
    {tag: 'span', children: 'hello world'}
  ]
}

function render(obj, root) {
  const { tag, children } = obj
  const el = document.createElement(tag)
  if (typeof children === 'string') {
    const textNode = document.createTextNode(children)
    el.appendChild(textNode)
  } else {
    children.forEach(item => {
      render(item, el)
    });
  }

  root.appendChild(el)
}
```

##### 运行时

用户直接使用我们上面的方法来渲染页面，但是**用户必须提供符合结构的数据才行**。

上述例子就是一个很经典的运行时框架的例子。

现在假设用户说写这种数据结构很麻烦，我想要实现jsx那样直接写模版然后渲染的效果行不行。

如果依然使用这个运行时的框架是不行的，那么这时候就要引入编译时了。

##### 编译时 + 运行时

**对用户输入的内容先进行编译**，以符合我们的数据结构要求。数据符合要求后仍然需要将数据传给我们的运行时去渲染才能获得最终的结果。

在编译时还可以记录用户输入内容中可能变化的部分记录下来，以提供进一步的性能优化。

这里可能就会想了？为什么我不在编译的时候直接编译成命令式的代码呢？命令式的代码性能不是比较好吗？

这就要是纯编译时框架了。

##### 编译时

**对用户输入的内容进行编译，直接生成命令式的代码。**连render函数都不需要了，直接就是编译后浏览器就认识。

##### 三种类型的框架比较

- 纯运行时：不好优化，无法分析用户输入的内容
- 编译时 + 运行时：可优化，性能中等
- 纯编译时：性能最好，但是代码必须编译过后才能使用，丧失了一定灵活性

**很火的 Svelte 框架就是纯编译时的架构，这也是为什么它宣称自己是最快性能最好的，vue2和vu3则都是编译时+运行时的架构**。  

## 二、虚拟DOM、组件、渲染器、编译器

- 虚拟DOM就是一种使用 js 描述真实DOM的数据结构
- 组件：组件可以看作是一组虚拟DOM的封装，可以是函数、可以是对象，只要其最后返回的是要渲染的虚拟DOM
- 渲染器负责递归的遍历虚拟DOM并通过原生的DOM API创建真实的DOM。
- 编译器负责将用户的模版编译为虚拟DOM

编译器可以在编译模版的同时通过新增标记来告诉渲染器哪些是将来可能会改变的值，以让渲染器做好优化的准备。