# å“åº”ç³»ç»Ÿ

[toc]

## å“åº”å¼æ•°æ®å’Œå‰¯ä½œç”¨å‡½æ•°

#### å‰¯ä½œç”¨å‡½æ•°

å‰¯ä½œç”¨å‡½æ•°å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ã€‚

æ¯”å¦‚å‡½æ•°ä¿®æ”¹äº†å…¨å±€å˜é‡ï¼Œä¿®æ”¹äº†DOMã€‚è¿™äº›æ“ä½œéƒ½å¯èƒ½å¯¹å…¶ä»–æ–¹æ³•äº§ç”Ÿå½±å“ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ã€‚

```js
function effectFn() {
  document.body.innerText = '123'
}
```

æ¯”å¦‚ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¿®æ”¹äº† body çš„æ–‡æœ¬å†…å®¹ï¼Œä½†æ˜¯å…¶ä»–å‡½æ•°ä¹Ÿå¯èƒ½ä¼šè¯»å–ã€ä¿®æ”¹ bodyï¼Œå°±ä¼šè¢«è¿™ä¸ªå‡½æ•°ç»™å½±å“åˆ°ã€‚

#### å“åº”å¼å‡½æ•°

å“åº”å¼å‡½æ•°å³å½“æˆ‘ä»¬ä¿®æ”¹è¯»å–çš„å¯¹è±¡çš„å€¼æ—¶ï¼Œå‡½æ•°åŒæ ·ä¹Ÿä¼šé‡æ–°æ‰§è¡Œã€‚

```js
const obj = { text: 'hello' }

function effectFn() {
  document.body.innerText = obj.text
}
```

å¦‚ä¸Šä»£ç ï¼Œæˆ‘å¸Œæœ›ä¿®æ”¹`obj.text`æ—¶ï¼Œ`effectFn`ä¹Ÿä¼šé‡æ–°æ‰§è¡Œï¼Œå¦‚æœçœŸçš„é‡æ–°æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆä»–å°±æ˜¯ä¸€ä¸ªå“åº”å¼å‡½æ•°ã€‚

##### æ€è·¯

- è¯»å–å€¼æ—¶æ”¶é›†è¯»å–å®ƒçš„å‡½æ•°ï¼ŒæŠŠå®ƒæ”¾åˆ°ä¸€ä¸ªâ€œğŸª£â€é‡Œ
- è®¾ç½®å€¼æ—¶å°†â€œğŸª£â€é‡Œçš„å‡½æ•°æ‹¿å‡ºæ¥é‡æ–°æ‰§è¡Œ

åœ¨ vue2 ä¸­é€šè¿‡`Object.defineProperty`æ¥æ‹¦æˆª`getter`å’Œ`setter`å®ç°ã€‚åœ¨ vue3 ä¸­åˆ™é€šè¿‡ proxy å®ç°ï¼

```js
// ä½¿ç”¨ proxy
const data = { text: 'hello' } // åŸå§‹æ•°æ®

const bucket = new Set()

const obj = new Proxy(data, {
  get(target, key) {
    bucket.add(effectFn) 
    return target[key]
  },
  set(target, key, value) {
    target[key] = value
    bucket.forEach(fn => fn())
    return true
  }
})

function effectFn() {
  document.body.innerText = obj.text
}
```

è¿™é‡Œæœ€å¤§çš„é—®é¢˜æ˜¯ç›´æ¥é€šè¿‡åå­—`effectFn`æ¥è·å–å‰¯ä½œç”¨å‡½æ•°ï¼Œå®é™…æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸çŸ¥é“åå­—æ˜¯ä»€ä¹ˆï¼Œç”šè‡³æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿ

##### å¤„ç†æ”¶é›†å‡½æ•°æ—¶ä¸çŸ¥é“å‡½æ•°åçš„æƒ…å†µ

æ—¢ç„¶æˆ‘ä»¬ä¸çŸ¥é“çœŸæ­£çš„è°ƒç”¨å‡½æ•°åï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªæ³¨å†Œå‡½æ•°å‡ºæ¥ï¼Œæ‰€æœ‰çš„å‡½æ•°éƒ½ä»è¿™é‡Œæ³¨å†Œä¸€éã€‚æ³¨å†Œåæ‹¥æœ‰ç»Ÿä¸€çš„æ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬æ”¶é›†è¿™ä¸ªæ ‡è¯†ç¬¦å°±å¯ä»¥äº†ã€‚

```js
let activeEffect // ç»Ÿä¸€æ ‡è¯†å
function effect(fn) {
  activeEffect = fn
  fn()
}

function effectFn() {
  document.body.innerText = obj.text
}

effect(effectFn) // æ³¨å†Œ
```

ä½†æ˜¯è¿™é‡Œè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬ä»£ç†çš„æ˜¯æ•´ä¸ª data å¯¹è±¡ï¼Œå°±ç®—ä¿®æ”¹çš„ä¸æ˜¯ text çš„å€¼ä¹Ÿä¼šæ‰§è¡Œâ€œğŸª£â€å†…çš„å‰¯ä½œç”¨å‡½æ•°ã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦**å»ºç«‹å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®æ ‡å­—æ®µä¹‹é—´çš„æ˜ç¡®å…³ç³»** 

##### å»ºç«‹æ˜ç¡®å…³ç³»

ä¸€ä¸ªå¯¹è±¡ä¼šæœ‰å¤šä¸ª keyï¼Œæ¯ä¸ª key åˆå¯èƒ½ä¼šæœ‰å¤šä¸ªä¾èµ–å®ƒçš„å‰¯ä½œç”¨å‡½æ•°ã€‚ä»–ä»¬ä¹‹é—´å­˜åœ¨ä¸‹é¢è¿™æ ·çš„æ ‘å½¢å…³ç³»ï¼š

> obj
> 	ï½œ-- key1
> 			 |--effectFn1
> 			 |--effectFn2
> 	|-- key2
> 			 |--effectFn1

æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å•çº¯çš„ä½¿ç”¨ä¸€ä¸ª set â€ğŸª£â€œæ¥å­˜ä¸‹æ‰€æœ‰çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè¿™æ ·ä¼šä½¿å‰¯ä½œç”¨å‡½æ•°å’Œkeyä¹‹é—´æ²¡æœ‰ä»»ä½•å¯¹åº”å…³ç³»ã€‚

**æˆ‘ä»¬å¯ä»¥é€šè¿‡ objã€keyã€effect ä¸‰è€…å»ºç«‹å¯¹åº”å…³ç³»ï¼Œobj æ˜¯å”¯ä¸€çš„ï¼Œobj çš„ key æ˜¯å¯è·å–çš„**

ä¸€æƒ³åˆ° key å’Œ value ä¸€ä¸€å¯¹åº”ï¼Œæˆ‘ä»¬å°±å¯ä»¥æƒ³åˆ° Map å¯¹è±¡ï¼ŒåŒæ—¶è¦æŠŠæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜åœ¨â€œğŸª£â€é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨WeakMapç±»åˆ«çš„â€ğŸª£â€œï¼Œè¿™æ ·ä¸ä¼šå½±å“å†…å­˜å›æ”¶å·¥ä½œã€‚

##### ä¸ºä»€ä¹ˆä½¿ç”¨ WeakMap

Map ä½¿ç”¨å¯¹è±¡ä½œä¸ºkeyçš„è¯ï¼Œè¿˜èƒ½é€šè¿‡Map.keysè®¿é—®åˆ°å¯¹è±¡ã€‚WeakMap æ˜¯å¼±å¼•ç”¨ï¼Œæ— æ³•å†è·å– WeakMap çš„key ï¼Œå¦‚æœä½œä¸º key çš„å¯¹è±¡ä¸å­˜åœ¨äº†ï¼ˆè¢«å›æ”¶äº†ï¼‰ WeakMap ä¸­çš„ key ä¹Ÿä¼šè¢«åƒåœ¾å›æ”¶å™¨æ­£ç¡®å›æ”¶ã€‚

æœ€ç»ˆæ”¹è¿›å¦‚ä¸‹ï¼š

```js
const bucket = new WeakMap()

const obj = new Proxy(data, {
  get(target, key) {
    if (!activeEffect) return target[key]
    
    let depsMap = bucket.get(target)
    if (!depsMap) {
      bucket.set(target, (depsMap = new Map()))
    }
    let deps = depsMap.get(key)
    if (!deps) {
      depsMap.set(key, (deps = new Set()))
    }
    
    deps.add(activeEffect)
    
    return target[key]
  },
  
  set(target, key, value) {
    target[key] = value
    
    const depsMap = bucket.get(target)
    if (!depsMap) return 
    
    const effects = depsMap.get(key)
    effects && effects.foreach(fn => fn())
  }
})
```

- bucket ç”± [target, Map] æ„æˆ
- Map ç”±[key, Set]æ„æˆ
- Set ç”± [effects] æ„æˆï¼Œå®ƒä¹Ÿæ˜¯å­—æ®µçœŸæ­£çš„**ä¾èµ–é›†åˆ ** 

æˆ‘ä»¬è¿˜å¯ä»¥æŠŠä¾èµ–è·Ÿè¸ªï¼ˆæ”¶é›†ï¼‰æ–¹æ³•æå–å‡ºæ¥ï¼Œä½œä¸º`track`æ–¹æ³•ï¼ŒæŠŠä¾èµ–è§¦å‘æ–¹æ³•æå–å‡ºæ¥ä½œä¸º`trigger`æ–¹æ³•ï¼

##### åˆ†æ”¯åˆ‡æ¢ä¸cleanup

æˆ‘ä»¬è·Ÿè¸ªä¾èµ–å‡½æ•°æ˜¯åœ¨å‡½æ•°è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå‡è®¾å‡½æ•°è¯»å–æ•°æ®æ—¶å…·æœ‰æ¡ä»¶åˆ¤æ–­ï¼Œå¦‚ä¸‹

```js
effect(function effectFn(){
  document.bodu.innerText = obj.ok ? obj.text : 'not'
})
```

å¦‚æœ `obj.ok`çš„å€¼ä¸€å¼€å§‹ä¸º trueï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œæ•°æ®å­—æ®µtrackæ•°æ®æ—¶ï¼Œä¼šå°†è¯¥å‡½æ•°ä½œä¸º ok å’Œ text ä¸¤ä¸ªå­—æ®µè·Ÿè¸ªçš„å‡½æ•°ã€‚

**é—®é¢˜æ¥äº†**

å½“`obj.ok`çš„å€¼ä¸º falseï¼ˆç†è§£ä¸º**æ¡ä»¶åˆ†æ”¯å‘ç”Ÿåˆ‡æ¢**ï¼‰æ—¶ï¼Œç†è®ºä¸Š`text`å­—æ®µä¸éœ€è¦å†è·Ÿè¸ªè¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°äº†ã€‚ä½†æ˜¯æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢çš„å“åº”å¼å®ç°ï¼Œ`obj.text`çš„ä¿®æ”¹ä¾ç„¶ä¼šè§¦å‘æ‰€æœ‰ä¾èµ–å®ƒçš„å‰¯ä½œç”¨å‡½æ•°ã€‚æ‰€ä»¥å½“å‰¯ä½œç”¨å‡½æ•°å‘ç”Ÿåˆ†æ”¯åˆ‡æ¢æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ cleanupã€‚

##### cleanup

å¦‚ä½• cleanup å‘¢ï¼Ÿæˆ‘ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯æ¯æ¬¡é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°è¯»å–æ•°æ®çš„æ—¶å€™æŠŠæ•´ä¸ªå¯¹è±¡ä» bucket ä¸­åˆ äº†ã€‚ä½†æ˜¯è¿™è‚¯å®šä¸è¡Œï¼Œä¸€ä¸ªå¯¹è±¡ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªå‡½æ•°è¯»äº†ï¼Œå¦‚æœæˆ‘ç›´æ¥æŠŠå®ƒåˆ äº†ï¼Œé‚£ä¹ˆå…¶ä»–å‡½æ•°ä¹Ÿä¼šè¢«å½±å“ã€‚

æ‰€ä»¥æˆ‘ä»¬åªèƒ½åœ¨å½“å‰å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œæ—¶ï¼Œè§£é™¤æ‰€æœ‰å¯¹å½“å‰è¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°çš„ trackï¼Œä¹‹åå†é‡æ–°å»ºç«‹ã€‚

é¦–å…ˆéœ€è¦çŸ¥é“è¿™ä¸ª**å‰¯ä½œç”¨å‡½æ•°è¢«å“ªäº›å­—æ®µtrackäº†**

æ€ä¹ˆåšå‘¢ï¼Ÿ

**æ€è·¯ï¼šæˆ‘ä»¬å¯ä»¥åœ¨è¢«trackçš„æ—¶å€™åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸­ä¿å­˜ä¸‹trackäº†æˆ‘çš„depsï¼Œç„¶åæ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå‰å…ˆä»è¿™ä¸ª deps ä¸­æŠŠæˆ‘æ¸…é™¤æ‰** 

åœ¨ä»£ç ä¸­å› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€çš„å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œå…¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨é‚£é‡Œç»§ç»­æ“ä½œã€‚

```js
function effect(fn) {
  const effectFn = () => {
    cleanup(effectFn)
    activeEffectFn = effectFn 
    fn()
  }
  effectFn.deps = []
  effectFn()
}

function cleanup(effectFn) {
  for (let i = 0; i < effectFn.deps.length; i++) {
    const deps = effectFn.deps[i]
    deps.delete(effectFn)
  }
  effectFn.deps = []Ã
}
```

åœ¨æ³¨å†Œå…¥å£ä¸­å¯¹ç”¨æˆ·ä¼ å…¥çš„å‰¯ä½œç”¨å‡½æ•°è¿›è¡ŒåŒ…è£…ï¼š

- æ–°å¢ä¸€ä¸ª`cleanup`æ–¹æ³•ï¼Œåœ¨æ¯æ¬¡æ‰§è¡Œè¯¥å‡½æ•°æ—¶éƒ½ä¼šè°ƒç”¨ï¼Œç”¨æ¥æ¸…é™¤åŸæ¥å¯¹è¿™ä¸ªå‡½æ•°æœ‰trackçš„å­—æ®µ
- æ–°å¢`deps`å±æ€§ï¼Œä¿å­˜æ‰€æœ‰å¯¹æœ¬å‰¯ä½œç”¨å‡½æ•°æœ‰ä¾èµ–çš„å­—æ®µçš„deps Set

å¯ä»¥åœ¨è·Ÿè¸ªå‡½æ•°æ—¶è®°å½•è¿™ä¸ªå…³ç³»

```js
function track(target, key) {
  // ...
  let deps = depsMap.get(key)
  if (!deps) {
    depsMap.set(key, (deps = new Set()))
  }
  deps.add(activeEffect)
  activeEffect.deps.push(deps) // è®°å½•å¯¹å½“å‰å‡½æ•°æœ‰è·Ÿè¸ªå…³ç³»çš„ Set
}
```

**å†æŒ‰ç…§ä¿®æ”¹åçš„ä»£ç æ€è·¯èµ°ä¸€é** 

1. ä¿®æ”¹ `obj.ok`çš„å€¼ï¼Œè§¦å‘äº† triggerï¼Œtrigger å‡½æ•°ä¸­æ‰¾åˆ°æ‰€æœ‰ä¾èµ–å®ƒçš„å‡½æ•°æ‰§è¡Œ

2. æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ¸…é™¤åŸæœ‰çš„ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯åˆé‡æ–°è¯»å–äº†`obj.ok`ï¼Œè§¦å‘äº† trackã€‚å­˜å‚¨ä¾èµ–å­—æ®µçš„å‡½æ•°çš„depsä¸€æ¸…é™¤åˆä¸€æ–°å¢ï¼Œ**è¿›å…¥äº†æ­»å¾ªç¯ï¼ˆSet åœ¨ forEach è¿‡ç¨‹ä¸­å¦‚æœæœ‰å±æ€§æ–°å¢é‚£ä¹ˆä¼šç»§ç»­éå†å®ƒï¼‰**

   ä¸»è¦æ˜¯ trigger ä¸­çš„è¿™å¥ä»£ç `effects && effects.forEach(fn => fn())`ï¼Œè¿™é‡Œçš„ fn å°±æ˜¯å‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°çš„è¿‡ç¨‹ä¸­åˆç»™è¿™ä¸ª effects æ–°å¢äº†æ•°æ®ã€‚

æ‰€ä»¥æˆ‘ä»¬è¦å¤„ç†è¿™ä¸ªæ­»å¾ªç¯é—®é¢˜ï¼ŒåŠæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªSetæ¥æ‰¿è½½å®ƒè¿›è¡Œéå†ï¼Œè¿™æ ·è€çš„ä¿®æ”¹å°±ä¸ä¼šå¯¹æ–°çš„äº§ç”Ÿå½±å“äº†ã€‚

```js
function trigger(target, key) {
  // ...
  const effects = depsMap.get(key)
  const newEffects = new Set(effects)
  newEffects && newEffects.forEach(fn => fn())
}
```

åˆ°æ­¤å°±å®Œæˆäº† cleanupã€‚

##### åµŒå¥—çš„ effect

åœ¨ vue.js ä¸­å¾ˆå®¹æ˜“å‡ºç°ç»„ä»¶çš„åµŒå¥—ï¼Œå½“ç„¶ä¹Ÿä¼šæœ‰æ•°æ®çš„åµŒå¥—ã€‚å‡è®¾æœ‰ä¸‹é¢è¿™æ ·ä¸€ä¸ªåµŒå¥—å‡½æ•°

```js
function effect(){ //... } æ³¨å†Œå‡½æ•°

let temp1, temp2
function effectFn1() {
	temp1 = obj.foo
  effect(function effectFn2(){
    temp2 = obj.bar
  })
}
```

ä½¿ç”¨æˆ‘ä»¬ä¸Šé¢çš„æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œå“åº”å¼å¤„ç†ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

å½“æˆ‘ä»¬è¯»å–`obj.foo`çš„å€¼è¿›è¡Œ track æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“`effectFn1`è‚¯å®šä¼šè§¦å‘ï¼Œ`effectFn2`ç”±äºè¢«åµŒå¥—åœ¨é‡Œé¢ä¹Ÿä¼šè§¦å‘ã€‚ä½†æ˜¯`effectFn2`ä¼š**è¢«è§¦å‘ 2 æ¬¡**ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

**å› ä¸º`activeEffect`æ˜¯å…¨å±€çš„ï¼Œä¸€æ—¦è¢«ä¿®æ”¹å°±ä¸ä¼šå†è¢«æ”¹å›å»äº†**ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†å®ƒæ”¹å›å»ã€‚

**æ€è·¯ï¼šåˆ©ç”¨æ ˆæ¥å­˜å‚¨å½“å‰æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä¸€æ—¦æ‰§è¡Œå®Œæˆå°±å‡ºæ ˆï¼Œå¹¶å°†å…¨å±€çš„`activeEffect`é‡æ–°è®¾ç½®ä¸ºæ ˆé¡¶é¡¶å‡½æ•°ã€‚**

```js
function effect(fn) {
  const effectFn = () => {
    cleanup(effectFn)
    activeEffect = effectFn // æœ€ç»ˆæˆä¸ºè¢«trackçš„å‡½æ•°æ˜¯å®ƒ
    effectStack.push(effectFn)
    fn()

    effectStack.pop() //æ”¯æŒåµŒå¥—
    activeEffect = effectStack[effectStack.length - 1]
  }
  effectFn.deps = [] // ä¿å­˜æ‰€æœ‰ä¾èµ–äº†æˆ‘çš„ deps
  effectFn()
}
```

##### æ— é™å¾ªç¯

æ— é™å¾ªç¯ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªå› ç´ ï¼Œå‡è®¾ä¸‹é¢è¿™æ ·ä¸€ä¸ªå‡½æ•°

```js
effect(() => obj.count++ )
```

åœ¨æ‰§è¡Œæ—¶è¯»å–äº†æ•°æ®è§¦å‘äº†trackï¼Œç„¶ååˆç»™æ•°æ®èµ‹å€¼è§¦å‘äº†triggerï¼Œåœ¨triggeræ—¶åˆè§¦å‘äº†å‡½æ•°ï¼Œè¿™æ—¶ä¸Šæ¬¡çš„è¿˜æ²¡æ‰§è¡Œå®Œï¼Œå½¢æˆäº†æ— é™å¾ªç¯ï¼Œå‡½æ•°æ— æ³•æ‰§è¡Œå®Œå‡ºæ ˆï¼Œæœ€åçˆ†æ ˆã€‚

ä¸ºäº†è·³å‡ºè¿™ä¸ªå¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦æ€ä¹ˆåšå‘¢ï¼Ÿ

**æ€è·¯ï¼štrigger æ—¶å¦‚æœå½“å‰å‡½æ•°åœ¨æ‰§è¡Œå°±ä¸è¦å†è§¦å‘äº†ã€‚åœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶æˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“çŸ¥é“ activeEffect å°±æ˜¯å½“å‰æ‰§è¡Œçš„å‡½æ•°**

åˆ¤æ–­`activeEffect`æ˜¯ä¸æ˜¯æ­£åœ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œä¸æ˜¯çš„è¯æ‰æ‰§è¡Œ

```js
function trigger(target, key) {
  // ...
  const effects = depsMap.get(key)
  const effectsToRun = new Set()
  effects && effects.forEach(effectFn => {
    if (activeEffect !== effectFn) {
      effectsToRun.add(effectFn)
    }
  })
  effectsToRun.forEach(effectFn => effectFn())
}
```

~~é™¤äº†æ— é™å¾ªç¯è¿™é‡Œè¿˜æœ‰å¼‚æ­¥é—®é¢˜ï¼Œå³å‰¯ä½œç”¨å‡½æ•°ä¸­æ˜¯å¼‚æ­¥è¯»å–æ•°æ®çš„ï¼Œä½†æ˜¯activeEffectå·²ç»è¢«é‡ç½®äº†ï¼Œå¯¼è‡´åœ¨ track çš„æ—¶å€™æ— æ³•è·å–åˆ°ï¼Œæ€è€ƒä¸€ä¸‹å¼‚æ­¥é—®é¢˜å¦‚ä½•å¤„ç†ï¼Ÿ~~

##### è°ƒåº¦å™¨

å®šä¹‰ï¼štrigger è§¦å‘æ—¶ï¼Œèƒ½æ§åˆ¶å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶æœºã€æ¬¡æ•°ä»¥åŠæ–¹å¼å³ä¸ºè°ƒåº¦å™¨ã€‚

**æ§åˆ¶æ‰§è¡Œæ—¶æœº**è¾ƒä¸ºç®€å•ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å‰¯ä½œç”¨å‡½æ•°æš´éœ²å‡ºå»äº¤ç»™ç”¨æˆ·ï¼Œç”±ç”¨æˆ·è‡ªå·±å†³å®šä»€ä¹ˆæ—¶å€™æ‰§è¡Œã€‚

```js
function effect(fn, options) {
  const effectFn = () => {
    // ...
  }
  effectFn.options = options
  effectFn()
}

effect(() => {
  console.log(obj.text)
}, {
  schedule(fn) {
    // ç”¨æˆ·å†³å®šå¯¹ fn åšä»€ä¹ˆ
  }
})
```

**æ§åˆ¶æ‰§è¡Œæ¬¡æ•°** 

æ§åˆ¶æ‰§è¡Œæ¬¡æ•°åˆ™ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨vue2ä¸­å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ•°æ®å¤šæ¬¡èµ‹å€¼æ—¶ï¼Œå¹¶ä¸ä¼šå¤šæ¬¡è§¦å‘æ¸²æŸ“å™¨ï¼Œåªæœ‰æœ€ç»ˆé‚£ä¸€æ¬¡ä¼šè§¦å‘æ¸²æŸ“ã€‚vue2 ç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ— `jobQueue`ï¼Œvue3 çš„æ€è·¯ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

**æ€è·¯ï¼šç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°†æ¯æ¬¡è¦æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°æ”¾å…¥ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆSet å»é‡ï¼‰ï¼Œåœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„å®ä»»åŠ¡ä¸­å¤šæ¬¡æ›´æ–°æ•°æ®æ—¶ï¼Œå®ä»»åŠ¡æ‰§è¡Œå®Œæˆåæ‰è¿›å…¥é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡æ‰§è¡Œï¼Œæ­¤æ—¶æ‹¿åˆ°çš„æ•°æ®å°±æ˜¯å®ä»»åŠ¡ä¸­æ›´æ–°çš„æœ€åä¸€æ¬¡æ•°æ®äº†ã€‚**  

```js
let jobQueue = new Set() // å»é‡é˜Ÿåˆ—
let isFlushing = false 
let p = Promise.resolve()

function flushJob() {
  if(isFlushing) return // å‰¯ä½œç”¨å‡½æ•°åœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­æƒ³å¤šæ¬¡æ‰§è¡Œæ—¶ä¼šè¢«é˜»æ­¢
  isFlushing = true
  
  p.then(() => { // å¾®ä»»åŠ¡é˜Ÿåˆ—
    jobQueue.forEach(job => job()) // å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œåè¿›å…¥
  }).finally(() => {
    isFlushing = false
  })
}

// ä¾ç„¶é€šè¿‡é€‰é¡¹æ¥æŒ‚è½½ä¸€ä¸ªè°ƒåº¦å™¨
function effect(fn, options = {}) {
  const effectFn = () => {}
  
  effectFn.options = options
}

effect(() => {console.log(obj.count)}, {
  schedule(fn) {
    jobQueue.add(fn) // æ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—
    flushJob()
  }
})
```

#### è®¡ç®—å±æ€§

è®¡ç®—å±æ€§å’Œå‰¯ä½œç”¨å‡½æ•°ä¸åŒï¼Œå®ƒå…·æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š

1. éœ€è¦æ—¶æ‰æ‰§è¡Œè®¡ç®—ï¼Œå¹¶ä¸ä¼šç›´æ¥æ‰§è¡Œ
2. ç¼“å­˜

æœ‰äº†ä¸Šé¢çš„å“åº”å¼å‡½æ•°å®ç°åï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„å®ç°ä¸€ä¸ªè®¡ç®—å±æ€§ã€‚

**æ€è·¯ï¼šé€šè¿‡ lazy å‚æ•°æ§åˆ¶å‰¯ä½œç”¨å‡½æ•°æ³¨å†Œæ—¶çš„è¡Œä¸ºâ€”â€”æ‰§è¡Œè¿˜æ˜¯ä¸æ‰§è¡Œ **ã€‚ä¸æ‰§è¡Œçš„æ—¶å€™è¿˜éœ€è¦æŠŠå‡½æ•°çš„åŸç»“æœè¿”å›å‡ºå»ã€‚

```js
function effect(fn, options) {
  const effectFn = () => {
    //...
    const res = fn()
    
    return res // è¿”å›å‡½æ•°ç»“æœ
  }
  
  effectFn.options = options
  if (!options.lazy) { // æœ‰ lazy æ—¶ä¸æ‰§è¡Œ
    effectFn()
  }
  return effectFn // è¿”å›å‰¯ä½œç”¨å‡½æ•°
}

function computed(getter) {
  const effectFn = effect(getter, {
    lazy: true
  })
  
  const obj = {
    get value() {
      return effectFn()
    }
  }
  return obj
}
```

éœ€è¦æ—¶æ‰æ‰§è¡Œçš„æ•ˆæœå·²ç»è¾¾åˆ°äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åšçš„æ˜¯è®¡ç®—å±æ€§çš„å¦ä¸€å¤§ç‰¹æ€§ç¼“å­˜ã€‚

ç›®å‰è¿™ä¸ªè®¡ç®—å±æ€§åœ¨æ¯æ¬¡è®¿é—®çš„æ—¶å€™éƒ½ä¼šé‡æ–°è®¡ç®—ï¼Œè¦è¿›è¡Œç¼“å­˜æˆ‘ä»¬å°±éœ€è¦æœ‰ç¼“å­˜çš„æ ‡å¿—ï¼Œè¦ç¼“å­˜ä¸Šä¸€æ¬¡çš„ç»“æœï¼Œå¹¶ä¸”è¦åœ¨ä¾èµ–çš„æ•°æ®æ”¹å˜æ—¶é‡ç½®ç¼“å­˜æ ‡å¿—ã€‚

- ä½¿ç”¨ dirty æ ‡å¿—æ•°æ®æ˜¯å¦æ˜¯è„æ•°æ®ï¼Œè„æ•°æ®éœ€è¦è¢«é‡æ–°è®¡ç®—
- ä½¿ç”¨ value ç¼“å­˜ä¸Šä¸€æ¬¡çš„ç»“æœ
- **triiger æ—¶ä½¿ç”¨è°ƒåº¦å™¨æ¥**é‡ç½® dirty çŠ¶æ€

```js
function computed(getter) {
  let dirty = true
  let value
  
  const effectFn = effect(getter, {
    lazy: true,
    scheduler(fn) {
      dirty = true
    }
  })
  
  const obj = {
    get value() {
      dirty = false
      value = effectFn()
    }
    return value
  }
  return obj
}
```

##### è®¡ç®—å±æ€§åµŒå¥—å¤„ç†

ä¸Šé¢å·²ç»è¾ƒä¸ºå®Œå–„çš„å®ç°äº†ä¸€ä¸ªè®¡ç®—å±æ€§ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“æˆ‘ä»¬å°†è®¡ç®—å±æ€§ä½œä¸ºä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ä¾èµ–çš„å€¼æ—¶ï¼ˆåµŒå¥—çš„æƒ…å†µï¼‰ï¼Œè®¡ç®—å±æ€§æ›´æ–°ä¸ä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚å³ä¸‹é¢è¿™ç§æƒ…å†µï¼š

```js
const sum = computed(() => obj.foo + obj.bar)
effect(() => {
  console.log(sum.value)
})
```

æˆ‘ä»¬ä¿®æ”¹`obj.foo`çš„å€¼å¸Œæœ›è®¡ç®—å±æ€§è‡ªåŠ¨é‡æ–°æ‰§è¡Œï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ã€‚

å› ä¸ºè®¡ç®—å±æ€§çš„ effect åœ¨è®¡ç®—å±æ€§å†…éƒ¨å¹¶ä¸”æ˜¯æ‡’æ‰§è¡Œçš„ï¼Œåªæœ‰æˆ‘ä»¬çœŸæ­£çš„å»è¯»å–è®¡ç®—å±æ€§çš„å€¼çš„æ—¶å€™æ‰èƒ½çœŸæ­£æ‰§è¡Œã€‚é‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿ

**æ€è·¯ï¼šè‡ªåŠ¨ä¸æ‰§è¡Œï¼Œé‚£ä¹ˆä»¬å°±æ‰‹åŠ¨å¸®è®¡ç®—å±æ€§ track å’Œ trigger**

ä»€ä¹ˆæ—¶å€™ triggerï¼Ÿå½“ç„¶æ˜¯ä¾èµ–çš„æ•°æ®å˜æ›´æ‰§è¡Œä»–ä»¬çš„å‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œé€šè¿‡è°ƒåº¦å™¨æ¥ trigger å½“å‰è®¡ç®—å±æ€§ã€‚ï¼ˆå¦‚æœè¿˜æ˜¯ç¼“å­˜æ•°æ®å°±æ²¡å¿…è¦è§¦å‘äº†ï¼‰

ä»€ä¹ˆæ—¶å€™ trackï¼Ÿå½“ç„¶æ˜¯è¯»å–æ•°æ®çš„æ—¶å€™ã€‚

trigger å’Œ track çš„éƒ½æ˜¯æˆ‘ä»¬ç”¨æ¥æ‰¿è½½è®¡ç®—å±æ€§çš„å¯¹è±¡ï¼Œkey éƒ½æ˜¯å†™æ­»çš„ `value` 

```js
function computed(getter) {
  let dirty = true
  let value
  
  const effectFn = effect(getter, {
    lazy: true,
    scheduler(fn) {
      if (!dirty) {
        dirty = true
        trigger(obj, 'value')
      }
    }
  })
  
  const obj = {
    get value() {
      dirty = false
      value = effectFn()
    }
    
    return value
  }
  return obj
}
```

#### watch

watch çš„å®ç°æ¯”è¾ƒç®€å•

**æ€è·¯ï¼šä½¿ç”¨è°ƒåº¦å™¨æ¥æ”¶ç”¨æˆ·ä¼ å…¥çš„å›è°ƒå‡½æ•°å¹¶æ‰§è¡Œ** 

```js
function watch(source, cb) {
  effect(
    () => traverse(source),
    {
      scheduler() {
        cb()
      }
    }
  )
}

// è¯»å–å¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§ä»¥trackå¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§
function traverse(value, seen = new Set()) {
  if(typeof value !== 'object' || value === null || seen.has(value)) return

  seen.add(value)

  for(const key in value) {
    traverse(value[key], seen)
  }
  return value
}
```

åœ¨ vue3 ä¸­ watch è¿˜å¯ä»¥æ¥æ”¶ä¸€ä¸ª getter å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ watch ä¸­å¯ä»¥åŠ å…¥ä¸‹é¢çš„åˆ¤æ–­

```js
function watch(source, cb) {
  let getter
  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }
  effect(() => getter(), {
    scheduler() {
      cb()
    },
  })
}
```

##### æ–°ã€æ—§å€¼è·å–

watch è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§æ˜¯èƒ½æ‹¿åˆ°æ—§å€¼ä¸æ–°å€¼ã€‚

è¦æƒ³åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ä¸Šé¢**è®¡ç®—å±æ€§çš„ lazy é€‰é¡¹**ï¼Œä¸€æ—¦åŠ å…¥ lazy é€‰é¡¹ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼ˆè¿™é‡Œæ˜¯ä¼ å…¥watch çš„getterï¼‰ï¼Œåªæœ‰ç­‰æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œä¹‹åæ‰ä¼šæ‹¿åˆ°æ–°å€¼ã€‚

- æ—§å€¼ï¼šç¬¬ä¸€æ¬¡åˆå§‹åŒ–çš„æ—¶å€™æ‰‹åŠ¨æ‰§è¡Œæ‹¿åˆ°
- æ–°å€¼ï¼štrigger æ—¶ï¼Œé€šè¿‡è°ƒåº¦å™¨è·å–ï¼Œå¹¶ä¸”å°†æ—§å€¼æ›´æ–°ä¸ºè¿™ä¸ªæ–°å€¼

```js
function watch(source, cb) {
  let getter
  let oldValue
  let newValue
  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }
  const effectFn = effect(() => getter(), {
    lazy: true,
    scheduler() {
      newValue = effectFn() // trigger è¿›å…¥è°ƒåº¦å™¨ä¹‹åè¯´æ˜å±æ€§æœ‰æ›´æ–°ï¼Œè·å–åˆ°çš„å°±æ˜¯æ–°å€¼
      cb(newValue, oldValue)
      oldValue = newValue // æ›´æ–°æ—§å€¼ä¸ºç°åœ¨çš„å€¼
    },
  })
  oldValue = effectFn() // ç¬¬ä¸€æ¬¡æ‰‹åŠ¨æ‰§è¡Œè·å–åˆ°çš„å°±æ˜¯åˆå§‹å€¼
}
```

å¦‚æœç›´æ¥ä¼ å…¥ä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œå› ä¸ºtraverseè¿”å›çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡æ‰€ä»¥æ–°å€¼å’Œæ—§å€¼çœ‹ä¸å‡ºåŒºåˆ«ã€‚

##### immediate é€‰é¡¹

åœ¨ vue ä¸­ watch è¿˜æ”¯æŒ immediate é€‰é¡¹ï¼Œç«‹å³æ‰§è¡Œã€‚è¿™å…¶å®å¾ˆå¥½å¤„ç†ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸‹è¯¥é€‰é¡¹æ˜¯å¦å¼€å¯ç„¶åç«‹å³æ‰§è¡Œ scheduler ä¸­çš„æ“ä½œã€‚

```js
function watch(source, cb, options = {}) {
  // ...
  const job = () => {
    newValue = effectFn() // trigger è¿›å…¥è°ƒåº¦å™¨ä¹‹åè¯´æ˜å±æ€§æœ‰æ›´æ–°ï¼Œè·å–åˆ°çš„å°±æ˜¯æ–°å€¼
    cb(newValue, oldValue)
    oldValue = newValue // æ›´æ–°æ—§å€¼ä¸ºç°åœ¨çš„å€¼
  }

  const effectFn = effect(() => getter(), {
    lazy: true,
    scheduler: job,
  })
  // å¦‚æœç«‹å³æ‰§è¡Œï¼Œé‚£ä¹ˆæœ€åˆçš„åˆå§‹å€¼ç›´æ¥å°±æ˜¯ undefined äº†
  if (options.immediate) {
    job()
  } else {
    oldValue = effectFn() // ç¬¬ä¸€æ¬¡æ‰‹åŠ¨æ‰§è¡Œè·å–åˆ°çš„å°±æ˜¯åˆå§‹å€¼
  }
}
```

##### ç«æ€é—®é¢˜å¤„ç†

åœ¨ä¸šåŠ¡å¼€å‘ä¸­ä¼šå­˜åœ¨è¿™æ ·ä¸€ç§é—®é¢˜ï¼Œåœºæ™¯ï¼šå‡½æ•°æ¯æ¬¡è§¦å‘éƒ½ä¼šå‘é€ä¸€ä¸ªè¯·æ±‚æ¥æ›´æ–° count å€¼ï¼Œå½“å‡½æ•°è¿ç»­è§¦å‘æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯å“ªä¸ªè¯·æ±‚å…ˆå›æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šä»¥ä¸ºæ˜¯æŒ‰ç…§è¯·æ±‚å‘é€çš„é¡ºåºï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥é—®é¢˜ã€‚å¯èƒ½Aè¯·æ±‚å…ˆå‘åè¿”å›ï¼Œæœ€åè·å–åˆ°çš„å€¼åè€Œæ˜¯è€çš„å€¼ã€‚

åœ¨ watch ä¸­å¾ˆå®¹æ˜“é‡åˆ°è¿™ç§é—®é¢˜ï¼Œvue3 æä¾›äº†ä¸€ä¸ª`onInvaliddate`æ–¹æ³•ç»™å›è°ƒå‡½æ•°ï¼Œå‘Šè¯‰ç”¨æˆ·è¿™ä¸ªå‰¯ä½œç”¨å›è°ƒå·²ç»è¿‡æœŸäº†ã€‚

æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œåœ¨æ¯æ¬¡triggerè§¦å‘è°ƒåº¦å‡½æ•°æ—¶ï¼Œåœ¨å›è°ƒå‰å…ˆè°ƒç”¨ä¸€ä¸‹è¿™ä¸ªè¿‡æœŸå›è°ƒã€‚

```js
function watch(source, cb, options = {}) {
  // ...
  let cleanup
  function onInvalidate(fn) { // æš´éœ²ç»™ç”¨æˆ·æ³¨å†Œ
    cleanup = fn
  }
  
  const job = () => {
    newValue = effectFn() 
    if(cleanup) { // æ¯æ¬¡éƒ½å…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸå‡½æ•°éœ€è¦æ‰§è¡Œ
      cleanup()
    }
    cb(newValue, oldValue, onInvalidate)
    oldValue = newValue
  }

  const effectFn = effect(() => getter(), {
    lazy: true,
    scheduler: job,
  })
  if (options.immediate) {
    job()
  } else {
    oldValue = effectFn() 
  }
}
```

**åœ¨ç¬¬ä¸€æ¬¡`cb`è°ƒç”¨çš„æ—¶å€™æˆ‘ä»¬è§¦å‘æ³¨å†Œä¸Šäº†è¿™ä¸ªè¿‡æœŸå›è°ƒ**ï¼Œåœ¨ç¬¬äºŒæ¬¡`cb`è°ƒç”¨çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™ä¸ªè¿‡æœŸå›è°ƒï¼Œé€šè¿‡é—­åŒ…è®¿é—®åˆ°çš„æ˜¯ç¬¬ä¸€æ¬¡æ³¨å†Œçš„æ—¶å€™å˜é‡ï¼ŒæˆåŠŸå°†ç¬¬ä¸€æ¬¡è§¦å‘ä¸­çš„å˜é‡çŠ¶æ€æ”¹å˜ã€‚ï¼ˆæ„Ÿè°¢ä¸‡èƒ½çš„é—­åŒ…ï¼‰

