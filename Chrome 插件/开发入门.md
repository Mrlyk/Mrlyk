# Chrome æ’ä»¶å¼€å‘å…¥é—¨

[toc]

## ä¸€ã€Chrome Extension ä»‹ç»

Chrome æ’ä»¶å…¶å®åº”è¯¥å« Chrome æ‰©å±•`Chrome Extension`ï¼Œå¯ä»¥ç®—æ˜¯ä¸€é—¨ Web å¼€å‘æŠ€æœ¯ï¼Œç”¨æ¥å¢å¼ºæµè§ˆå™¨çš„åŠŸèƒ½ã€‚**å®ƒå…¶å®æ˜¯ä¸€ä¸ªç”± HTMLã€CSSã€JS å›¾ç‰‡ç­‰èµ„æºç»„æˆçš„ä¸€ä¸ª `.crx`åç¼€çš„å‹ç¼©åŒ…**ã€‚ï¼ˆç”±äºæ‰©å±•æ˜¯æ›´åˆé€‚çš„ç¿»è¯‘ï¼Œæ‰€ä»¥åé¢ç»Ÿç§°ä¸ºæ‰©å±•ï¼‰

![image-20220115165008442](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220115165008442.png?x-oss-process=image/resize,w_600,m_lfit)

**é™¤äº†è°ƒç”¨æµè§ˆå™¨è‡ªå¸¦çš„åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é…åˆ C++ ç¼–å†™çš„ dll åŠ¨æ€åº“å®ç°æ›´åº•å±‚çš„åŠŸèƒ½ï¼ˆNAPIï¼Œ å°±åƒ IE ä¸Šçš„ activexï¼‰**

```json
{
  "plugins": [
    "path": "plugin/test.dll" // å°† dll æ–‡ä»¶æ”¾åœ¨æ‰©å±•çš„ plugin ç›®å½•ä¸‹å³å¯è°ƒç”¨
  ]
}
```

```text
ç”±äºå®‰å…¨åŸå› ï¼ŒChromeæµè§ˆå™¨42ä»¥ä¸Šç‰ˆæœ¬å·²ç»é™†ç»­ä¸å†æ”¯æŒNPAPIæ’ä»¶ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ›´å®‰å…¨çš„PPAPIã€‚
PPAPIï¼šä¾›Opera ï¼ˆ15ä»¥ä¸Šï¼‰ã€Chromiumï¼ˆå¼€æºè°·æ­Œï¼‰æµè§ˆå™¨ä½¿ç”¨
NPAPIï¼šé€‚ç”¨äºFireFoxï¼ˆç«ç‹ï¼‰ã€Safariï¼ˆè‹¹æœï¼‰ã€Opera ï¼ˆæ¬§æœ‹ï¼Œ12.17ç‰ˆä»¥ä¸‹ï¼‰
```

#### æ‰©å±•å¯ä»¥åšä»€ä¹ˆ

- ä¹¦ç­¾æ§åˆ¶
- ä¸‹è½½æ§åˆ¶
- çª—å£æ§åˆ¶
- æ ‡ç­¾æ§åˆ¶
- ç½‘ç»œè¯·æ±‚æ§åˆ¶ã€äº‹ä»¶ç›‘å¬
- è‡ªå®šä¹‰åŸç”Ÿèœå•
- å®Œå–„çš„é€šä¿¡æœºåˆ¶
- ......

*ps: Firefox ä¹Ÿå¯¹ Chrome æ‰©å±•æä¾›äº†ä¸€å®šçš„å…¼å®¹æ€§*

#### å¼€å‘ä¸è°ƒè¯•

**é¡¹ç›®ç»“æ„**

Chrome æ‰©å±•å¯¹é¡¹ç›®ç»“æ„æ²¡æœ‰è¦æ±‚ï¼Œåªè¦ä¿è¯æ ¹ç›®å½•ä¸­æœ‰`manifest.json`å³å¯ã€‚

\- manifest.json

**è°ƒè¯•**

è¿›å…¥æµè§ˆå™¨æ‰©å±•ç¨‹åºé¡µé¢ï¼Œæ‰“å¼€å¼€å‘è€…æ¨¡å¼å³å¯**åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº**ï¼Œç”¨äºè°ƒè¯•ã€‚å¦‚æœä»£ç æœ‰æ”¹åŠ¨ï¼Œåªéœ€è¦åœ¨æ‰©å±•ç®¡ç†é¡µé¢åˆ·æ–°å³å¯ã€‚

## äºŒã€å¼€å‘å…¥é—¨

é¦–å…ˆè¦æ³¨æ„ä¸€ç‚¹ï¼ŒChrome éµå¾ª CSP å®‰å…¨ç­–ç•¥ï¼Œæ‰€ä»¥ html ä¸­çš„å†…è”è„šæœ¬éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œé™¤éæ‰‹åŠ¨é…ç½®å…è®¸ã€‚æ‰€ä»¥ js æ“ä½œæœ€å¥½å†™å…¥å•ç‹¬çš„å¤–éƒ¨ js ä¸­ï¼Œé€šè¿‡ script æ ‡ç­¾å¼•å…¥ã€‚

#### 2.1 manifest.json

æ‰©å±•å¼€å‘æœ€é‡è¦çš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ã€‚å…¶ä¸­æœ‰ä¸‰ä¸ªé…ç½®é€‰é¡¹æ˜¯å¿…å¡«çš„

- `manifest_version`ï¼šæ‰©å±•æ‰€ç”¨æ¸…å•ç‰ˆæœ¬ï¼Œç›®å‰å¤§éƒ¨åˆ†æ˜¯ 2ï¼ŒChrome 88 ç‰ˆæœ¬ä¹‹åæ”¯æŒ 3 ï¼ŒåŒæ—¶ google è¡¨ç¤ºæœªæ¥å¯èƒ½åœæ­¢ 2 ç‰ˆæœ¬çš„æ”¯æŒï¼Œæ‰€ä»¥æ–°å¼€å‘æ’ä»¶æœ€å¥½ç”¨ 3 ç‰ˆæœ¬
- `name`ï¼šæ‰©å±•å
- `version`ï¼šæ‰©å±•ç‰ˆæœ¬

å¦å¤–ä¸¤ä¸ªæ˜¯å®˜æ–¹æ¨èçš„æœ€å¥½å¡«çš„

- `description`ï¼šæ‰©å±•æè¿°
- `icons`ï¼šæ‰©å±•å›¾æ ‡

ä¸‹é¢åˆ—å‡ºä¸€äº›å…¶ä»–çš„å¸¸è§é…ç½®é¡¹

```json
{
  "manifest_version": 2, // æ¸…å•ç‰ˆæœ¬
  "name": "demo1", // æ’ä»¶åç§°
  "version": "1.0.0", // æ’ä»¶ç‰ˆæœ¬
  "description": "æ’ä»¶å¼€å‘æµ‹è¯•1",
  "icons": { // ä¸åŒå°ºå¯¸çš„å›¾æ ‡ï¼ˆè®¾ç½®é¡µé¢å’Œå•†åº—å›¾æ ‡ï¼‰
    "16": "img/icon.png",
    "48": "img/icon.png",
    "128": "img/icon.png"
  },
  "background": { // å¸¸é©»åå°çš„é¡µé¢æˆ–è€… jsï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ªã€‚å¦‚æœæŒ‡å®š js åˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªèƒŒæ™¯é¡µ
    "page": "background.html", // åœ¨ chrome > 92 ç‰ˆæœ¬åæ‰æä¾›äº†type: module æ¨¡å—åŒ–é€‰é¡¹ã€‚ä¹‹å‰æ˜¯ä¸æ”¯æŒç›´æ¥çš„æ¨¡å—åŒ–åŠ è½½çš„ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ type="module"
    // "scripts": ["js/background.js"]  
  },
  "browser_action": { // æµè§ˆå™¨å³ä¸Šè§’çš„å›¾æ ‡è®¾ç½® browser_actionã€page_action äºŒé€‰ä¸€
    "default_icon": "img/icon.png", // æ”¯æŒå¤šä¸ª { 16:x, 24:xx, 32: xxx}
    "default_title": "æµ‹è¯•æ’ä»¶1",
    "default_popup": "popup.html"
  },
  "page_action": { // æŸäº›ç‰¹å®šé¡µé¢æ‰æ˜¾ç¤ºçš„å›¾æ ‡
    "default_icon": "img/icon.png",
    "default_title": "æµ‹è¯•æ’ä»¶1-pageAction",
    "default_popup": "popup.html"
  }
  "content_scripts": [ // éœ€è¦æ³¨å…¥é¡µé¢çš„url
    {
      "matches": [ // åŒ¹é…è§„åˆ™ï¼Œ<all_urls> è¡¨ç¤ºæ‰€æœ‰åœ°å€ï¼Œå¯ä»¥ç”¨ "http://*/*" è¿™æ ·çš„ url åŒ¹é…
        "<all_urls>"
      ],
      "js": [ // æŒ‰é¡ºåºæ³¨å…¥çš„ js
        "js/jquery-1.8.3,js",
        "js/content-script.js"
      ],
      "css": [ // æ³¨å…¥çš„ css æ ·å¼ï¼Œæ³¨æ„æ ·å¼ä¼šå¯¹å…¨å±€äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥åƒä¸‡è¦è§„èŒƒ
        "css/custom.css"
      ],
			/ **
			* ä»£ç æ³¨å…¥æ—¶æœº
			* document_startï¼šdom åŠ è½½å¼€å§‹å‰
			* document_endï¼šdom åŠ è½½å®Œæˆå
			* document_idleï¼šé¡µé¢ç©ºé—²æ—¶ - é»˜è®¤å€¼ï¼Œåœ¨ documen_end å’Œ window.onload ä¹‹é—´
			*/
      "run_at": "document_start" 
    },
    { // å¯å£°æ˜å¤šä¸ªä»¥å¤„ç†ä¸åŒçš„æƒ…å†µ
      "matches": [
        "*://*/*.png",
        "*://*/*.jpg",
        "*://*/*.gif",
        "*://*/*.bmp"
      ],
      "js": ["js/show-image-content-size.js"]
    }
  ],
  "permissions:": [ // æƒé™ç”³è¯·
    "contextMenus", // å³é”®èœå•æƒé™
    "tabs", // æ ‡ç­¾é¡µæƒé™
    "notification", // é€šçŸ¥æƒé™
    "webRequest", // ç½‘ç»œè¯·æ±‚æƒé™
    "webRequestBlocking",
    "storage", // æœ¬åœ°å­˜å‚¨æƒé™
    "http://*/*", // å…è®¸è¯»å–æˆ–æ“ä½œçš„ç½‘ç«™
    "https://*/*"
  ],
  "web_accessible_resources": [ // é¡µé¢èƒ½è®¿é—®åˆ°çš„æœ¬æ’ä»¶çš„èµ„æºåˆ—è¡¨ï¼Œé€šè¿‡ content-scrpipt æ³¨å…¥çš„ js æ¯”å¦‚ä¸€äº›æ ¼å¼åŒ–æ–¹æ³•ï¼Œåœ¨é¡µé¢ä¸Šæ˜¯æ— æ³•è°ƒç”¨çš„ã€‚è¦æƒ³è®©é¡µé¢è®¿é—®æ’ä»¶ä¸­çš„æ–¹æ³•åˆ™è¦åœ¨è¯¥é…ç½®ä¸­å£°æ˜å’Œæ³¨å…¥
    "js/inject.js"
   ],
  "homepage_url": "https://www.baidu.com", // è®¿é—®æ’ä»¶åçš„ä¸»é¡µï¼ˆå¾ˆé‡è¦ï¼‰ï¼Œé€šè¿‡é¼ æ ‡å³é”®æ’ä»¶å›¾æ ‡ç¬¬ä¸€ä¸ªé€‰é¡¹æ‰“å¼€çš„é¡µé¢
	"chrome_url_overrides": { // è¦†ç›–æµè§ˆå™¨é»˜è®¤çš„é¡µé¢
    "newtab": "newtab.html" // è¦†ç›–æµè§ˆå™¨é»˜è®¤çš„æ–°æ ‡ç­¾é¡µï¼Œæ¯”å¦‚æ˜é‡‘çš„æ’ä»¶ï¼Œè¿˜æœ‰ä¹¦ç­¾ bookmarksã€å†å²è®°å½• history ä¸¤ä¸ªé€‰é¡¹ï¼Œä½†æ˜¯ä¸èƒ½åŒæ—¶ä½¿ç”¨
  },
  "options_page": "options.html", // chrome < 40 å‰çš„ æ’ä»¶é…ç½® é¡µé¢
  "options_ui": {  // chrome >= 40 åçš„ æ’ä»¶é…ç½® é¡µé¢ï¼Œéƒ½å†™æ—¶ä»¥æ–°çš„ä¸ºå‡†
    "page": "options.html",
    "chrome_style": true
  },
  "omnibox": { // å‘åœ°å€æ æ³¨å†Œä¸€ä¸ªå…³é”®å­—ä»¥æä¾›æœç´¢å»ºè®®ï¼Œåªèƒ½è®¾ç½®ä¸€ä¸ªå…³é”®å­—
    "keyword": "go"
  },
  "default_locale": "zh_CN", // é»˜è®¤è¯­è¨€ï¼Œå¦‚æœæŒ‡å®šæ­¤é€‰é¡¹åˆ™éœ€è¦åŒ…å«ä¸€ä¸ª _locals æ–‡ä»¶å¤¹
  "devtools_page": "devtools.html" // devtools é¡µé¢å…¥å£ï¼Œæ³¨æ„åªèƒ½æŒ‡å‘ä¸€ä¸ª html æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯ js æ–‡ä»¶ã€‚å°±æ˜¯æˆ‘ä»¬æ‰“å¼€ devtools æ—¶ä¼šé¢å¤–æœ‰ä¸€ä¸ªè¯¥æ’ä»¶çš„ tabï¼Œä»¥è®©æˆ‘ä»¬è®¿é—® devtools çš„ä¸€äº› api
}
```

**é…ç½®çš„æ–‡ä»¶è·¯å¾„ï¼Œéƒ½æ˜¯ç›¸å¯¹äºæ ¹ç›®å½•çš„**

é™¤äº†ä¸Šé¢å¸¸è§çš„é…ç½®é¡¹å¤–ï¼Œå®Œæ•´é…ç½®å¯ä»¥æŸ¥çœ‹ä¸‹é¢çš„å®˜æ–¹æ–‡æ¡£ï¼š

V2 ç‰ˆæœ¬æ¸…å•é…ç½®å®˜æ–¹æ–‡æ¡£ï¼šhttps://developer.chrome.com/docs/extensions/mv2/manifest/

V3 ç‰ˆæœ¬æ¸…å•é…ç½®å®˜æ–¹æ–‡æ¡£ï¼šhttps://developer.chrome.com/docs/extensions/mv3/intro/mv3-overview/

v2 -> v3 è¿ç§»æ–‡æ¡£ï¼šhttps://developer.chrome.com/docs/extensions/mv3/intro/mv3-migration/

ä¸Šé¢æ˜¯åŸºç¡€è¯´æ˜ï¼Œä¸‹é¢å¯¹ manifest.json ä¸­é‡è¦çš„é…ç½®åšè¯¦ç»†è¯´æ˜ã€‚

#### 2.2 content-scripts æ“ä½œDOM

content-scripts ç”¨ä»¥å‘é¡µé¢æ³¨å…¥ js å’Œ cssï¼Œä»–æœ‰å‡ ä¸ªç‰¹æ€§ï¼š

1. ä¸é¡µé¢å…±äº« dom
2. ä¸ä¸é¡µé¢å…±äº« js æ‰§è¡Œç¯å¢ƒã€‚å¦‚æœè¦é€šè¿‡æ’ä»¶è®¿é—®é¡µé¢çš„ js æ‰§è¡Œç¯å¢ƒï¼Œåªèƒ½é€šè¿‡`web_accessible_resources`æ³¨å…¥çš„æ‰å¯ä»¥ï¼Ÿï¼ˆå¾…ç¡®è®¤ï¼‰
3. **content-scripts ä¸­**å¯ä»¥ä½¿ç”¨å°éƒ¨åˆ† Chrome æä¾›çš„ API ä»¥å®Œæˆæˆ‘ä»¬æƒ³è¦çš„æ“ä½œ

```text
V2 å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å››ç§ APIï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥çœ‹æ–‡æœ«çš„ API å®˜æ–¹æ–‡æ¡£
chrome.extension(getURL , inIncognitoContext , lastError , onRequest , sendRequest)
chrome.i18n
chrome.runtime(connect , getManifest , getURL , id , onConnect , onMessage , sendMessage)
chrome.storage
```

```json
{
  "content_scripts": [ // éœ€è¦æ³¨å…¥é¡µé¢çš„url
    {
      "matches": [ // åŒ¹é…è§„åˆ™ï¼Œ<all_urls> è¡¨ç¤ºæ‰€æœ‰åœ°å€ï¼Œå¯ä»¥ç”¨ "http://*/*" è¿™æ ·çš„ url åŒ¹é…
        "<all_urls>"
      ],
      "js": [ // æŒ‰é¡ºåºæ³¨å…¥çš„ js
        "js/jquery-1.8.3,js",
        "js/content-script.js"
      ],
      "css": [ // æ³¨å…¥çš„ css æ ·å¼ï¼Œæ³¨æ„æ ·å¼ä¼šå¯¹å…¨å±€äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥åƒä¸‡è¦è§„èŒƒ
        "css/custom.css"
      ],
			/ **
			* ä»£ç æ³¨å…¥æ—¶æœº
			* document_startï¼šdom åŠ è½½å¼€å§‹å‰
			* document_endï¼šdom åŠ è½½å®Œæˆå
			* document_idleï¼šé¡µé¢ç©ºé—²æ—¶ - é»˜è®¤å€¼ï¼Œåœ¨ documen_end å’Œ window.onload ä¹‹é—´
			*/
      "run_at": "document_start" 
    }
  ]
}
```

å…³äºæ³¨å…¥æ—¶æœºè¦æ³¨æ„æ³¨å…¥çš„é»˜è®¤æ—¶æœºæ˜¯ `document_idle`ï¼Œæ‰€ä»¥å¦‚æœæ³¨å…¥çš„ä»£ç ä¸­æœ‰`DOMContentLoaded`è¿™ç§äº‹ä»¶çš„ç›‘å¬ï¼Œå°±éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ³¨å…¥æ—¶æœºä¸ºæ›´æ—©çš„`document_start`ã€‚

é€šè¿‡æ³¨å…¥ JS å…¶å®å·²ç»å¯ä»¥åšå¾ˆå¤šäº‹æƒ…äº†ï¼Œå½“ç„¶é…åˆ Chrome æä¾›çš„ä¸€äº›å…¶ä»– API å¯ä»¥å®ç°æ¯”çº¯é¡µé¢ä¸Šæ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚

#### 2.3 background åå°

background æ˜¯ä»æµè§ˆå™¨å¼€å§‹ï¼Œåªè¦æ‰©å±•å¼€å¯å°±ä¼šä¸€ç›´å¸¸é©»åœ¨åå°çš„ç¨‹åºï¼Œä»–çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æœ€é•¿çš„ã€‚ä»æµè§ˆå™¨å¼€å§‹å°±ä¸€ç›´è¿è¡Œä¸€ç›´åˆ°æµè§ˆå™¨å…³é—­ã€‚**ä¸€èˆ¬æ¥è¯´æ’ä»¶è‡ªèº«çš„é€»è¾‘å†™åœ¨ backgroud ä¸­ï¼Œä¸é¡µé¢æœ‰äº¤äº’çš„é€»è¾‘åˆ™å†™åœ¨å„æ³¨å…¥æ–‡ä»¶ä¸­**

**background çš„æƒé™éå¸¸é«˜ï¼Œå‡ ä¹å¯ä»¥è°ƒç”¨é™¤ devtool ä¸­çš„ä¸€åˆ‡æ‰©å±• APIï¼Œè€Œä¸”ä»–å¯ä»¥æ— é™åˆ¶è·¨åŸŸï¼Œå³ä¸éœ€è¦å¯¹æ–¹çš„æœåŠ¡è®¾ç½®è·¨åŸŸä¹Ÿå¯ä»¥è®¿é—®ã€‚**

```json
{
  "background": { // å¸¸é©»åå°çš„é¡µé¢æˆ–è€… jsï¼Œåªèƒ½å­˜åœ¨ä¸€ä¸ªã€‚å¦‚æœæŒ‡å®š js åˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªèƒŒæ™¯é¡µ
    "page": "background.html",
    // "scripts": ["js/background.js"] 
  }
}
```

**event-pages**

ç”±äº background çš„ç”Ÿå‘½å‘¨æœŸå¤ªé•¿ï¼Œéš¾ä»¥é¿å…çš„ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥è¯ç”Ÿäº†`event-pages`ã€‚**å®ƒä¸ background å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å¤šäº†ä¸€ä¸ª persistent å‚æ•°ï¼Œå…¶ä»–è¿é…ç½®åéƒ½æ˜¯ç”¨çš„ background**

```json
{
  "background": {
    "scripts": ["event-page.js"],
    "persistent": false
  }
}
```

persistentï¼š

- trueï¼šé»˜è®¤å€¼ï¼Œè¡¨ç¤ºåå° js å¸¸é©»
- falseï¼šè¡¨ç¤ºåœ¨åˆé€‚çš„æ—¶å€™æ‰åŠ è½½åå° js ã€‚æ¯”å¦‚**ç¬¬ä¸€æ¬¡å®‰è£…ã€æ’ä»¶æ›´æ–°ã€content-script é€šä¿¡ç­‰**

#### 2.4 popup å³ä¸Šè§’å¼¹å‡ºäº¤äº’

popup æ˜¯ç‚¹å‡»`browser action`æˆ–è€…`page action`ï¼ˆæµè§ˆå™¨å³ä¸Šè§’çš„å°å›¾æ ‡ï¼‰æ—¶å¼¹å‡ºçš„çª—å£ï¼Œå¤±ç„¦æ—¶å…³é—­ã€‚

![image-20220116192908985](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220116192908985.png?x-oss-process=image/resize,w_200,m_lfit) 

popup å¯ä»¥åŒ…å«ä»»ä½• HTML å†…å®¹ï¼Œå¹¶ä¸”ä¼šè‡ªé€‚åº”å¤§å°ã€‚å®ƒçš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­ï¼Œåœ¨å…³é—­æ—¶ç»“æŸã€‚

```json
{
  "browser_action": {
    "default_popup": "popup.html" // é€šè¿‡è¯¥é…ç½®æŒ‡å®š popup é¡µé¢
  }
}
```

åœ¨æƒé™ä¸Šï¼Œpopup å’Œ background å¾ˆç›¸ä¼¼ï¼Œæœ€å¤§çš„ä¸åŒå°±æ˜¯ç”Ÿå‘½å‘¨æœŸçš„åŒºåˆ«ã€‚åœ¨ popup ä¸­è¿˜å¯ä»¥é€šè¿‡`chrome.extension.getBackgroundPage()`è·å– background çš„ window å¯¹è±¡ã€‚

#### 2.5 web_accessible_resources js æ³¨å…¥

é€šè¿‡ content-script æ³¨å…¥çš„ js å­˜åœ¨ä¸€ä¸ªå±€é™æ€§ï¼š**æ— æ³•è¢«é¡µé¢ä¸Šçš„å¯¹è±¡è®¿é—®**ã€‚å¦‚æœæƒ³è¦é€šè¿‡é¡µé¢ä¸Šçš„å¯¹è±¡ç›´æ¥è®¿é—®æ’ä»¶çš„è¯ï¼Œéœ€è¦ä½¿ç”¨`web_accessible_resources`æ‰è¡Œ

```json
{
  "web_accessible_resources": ["js/inject.js"]
}
```

åŒæ—¶ inject.js ä¹Ÿå¯ä»¥å’Œ content-script ä¸­æ³¨å…¥çš„ js é€šä¿¡ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨é¡µé¢ä¸Šè°ƒç”¨æ’ä»¶çš„åŠŸèƒ½ã€‚

**è¦é€šè¿‡ JSONP æ–¹å¼ï¼Œæ‰‹åŠ¨æ’å…¥ä¸€ä¸ª script æ ‡ç­¾ï¼ŒåŒæ—¶é…åˆè¯¥é€‰é¡¹ä¸€èµ·ç”¨æ‰è¡Œ** 

```js
function injectCustomJs(jsPath)
{
	jsPath = jsPath || 'js/inject.js';
	var temp = document.createElement('script');
	temp.setAttribute('type', 'text/javascript');
	// è·å¾—çš„åœ°å€ç±»ä¼¼ï¼šchrome-extension://ihcokhadfjfchaeagdoclpnjdiokfakg/js/inject.js
	temp.src = chrome.runtime.getURL(jsPath);
	temp.onload = function()
	{
		// æ‰§è¡Œå®Œåç§»é™¤æ‰ï¼ˆå¤–éƒ¨å¼•å…¥çš„ js ä¼šå°†å…¶ä¸­çš„æ–¹æ³•æ‰§è¡Œå®Œæˆåæ‰å›è°ƒ onload æ–¹æ³•ï¼Œç”±äºä»£ç å·²ç»æ‰§è¡Œäº†ï¼Œæ‰€ä»¥ onload æ—¶åˆ æ‰æ ‡ç­¾å·²ç»æ²¡æœ‰å…³ç³»äº†ï¼‰
		this.parentNode.removeChild(this);
	};
	document.head.appendChild(temp);
}
```

å¦‚æœæ²¡æœ‰é…ç½®è¯¥é€‰é¡¹åˆ™ä¼šæŠ¥é”™:

![image-20220117211922660](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220117211922660.png?x-oss-process=image/resize,w_600,m_lfit)



#### 2.6 homepage_url ä¸»é¡µ

å¯ä»¥é€šè¿‡å¦‚ä¸‹ï¼Œå³é”®æ‰©å±•çš„ç¬¬ä¸€é¡¹æ‰“å¼€ã€‚æˆ–è€…æ’ä»¶è¯¦æƒ…é¡µ -> æ‰“å¼€æ‰©å±•ç¨‹åºç½‘ç«™ æ¥æ‰“å¼€

![image-20220117212526427](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220117212526427.png?x-oss-process=image/resize,w_600,m_lfit) 



## ä¸‰ã€Chrome æ‰©å±•çš„å­˜åœ¨å½¢å¼

*æ ‡é¢˜åæœ‰æ‹¬å·çš„è¡¨ç¤ºéœ€è¦åœ¨ manifest.json çš„ permissions ä¸­å£°æ˜* 

#### 3.1 browserAction å³ä¸Šè§’

- é¼ æ ‡æ‚¬æµ®æˆ–è€…å³é”®ç‚¹å‡»å³ä¸Šè§’æ’ä»¶å¯ä»¥çœ‹åˆ°`default_title`
- é¼ æ ‡å·¦é”®ç‚¹å‡»å¯ä»¥æ‰“å¼€`popuo.html`

```json
{
  "browser_action": {
    "default_icon": "img/icon.png",
    "default_title": "demo1",
    "default_popup": "popup.html"
  }
}
```

ä»¥ä¸Šé…ç½®é¡¹è¿˜å¯ä»¥é€šè¿‡ä»£ç åŠ¨æ€è®¾ç½®ï¼š

```js
chrome.browserAction.setIcon(); // è®¾ç½®å›¾ç‰‡
chrome.browserAction.setTitle(); // è®¾ç½®åç§°
chrome.browserAction.setPopup; // è®¾ç½®å¼¹å‡ºæ¡†
```

default_icon æ¨èä½¿ç”¨ 19px çš„å›¾ç‰‡ï¼Œæ›´å¤§çš„ä¼šè¢«å‹ç¼©ã€‚

**badge** 

é™¤äº†ä¸Šé¢å‡ ä¸ªå±•ç¤ºçš„ä¸œè¥¿ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª badge æç¤ºï¼Œå¯ä»¥å‘Šè¯‰ç”¨æˆ·ä¸€äº›æç¤ºä¿¡æ¯ã€‚æ¯”å¦‚å¹¿å‘Šæ‹¦æˆªæ’ä»¶å¯ä»¥æ˜¾ç¤ºæ‹¦æˆªäº†å¤šå°‘æ•°é‡çš„å¹¿å‘Šã€‚

![image-20220117214651215](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220117214651215.png?x-oss-process=image/resize,w_200,m_lfit) 

**badge åªèƒ½é€šè¿‡ä»£ç è®¾ç½®ï¼Œä¸”åªåœ¨ browserAction é…ç½®æ—¶æœ‰æ•ˆ**ï¼Œæœ€å¤š4ä¸ªå­—èŠ‚ï¼ˆ2ä¸ªä¸­æ–‡ã€4ä¸ªè‹±æ–‡ï¼‰

```js
chrome.browserAction.setBadgeText({text: '99+'});
chrome.browserAction.setBadgeBackgroundColor({color: 'red'});
```

**æ³¨æ„**ï¼š`browserAction`åªèƒ½åœ¨æ‰©å±•é¡µä¹Ÿå°±æ˜¯ backgroud ä¸­è®¿é—®åˆ°ï¼Œåœ¨å†…å®¹é¡µé¢å¦‚ content-scriptã€inject.js ä¸­å‡è®¿é—®ä¸åˆ°ã€‚*options é¡µé¢èƒ½å¦è®¿é—®å¾…ç¡®è®¤ï¼Ÿ* **è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹ background çš„æƒé™æ˜¯éå¸¸é«˜çš„ï¼Œæ‰€ä»¥ä¸ºä»€ä¹ˆè¿™é‡Œæ‰èƒ½åœ¨ backgroud ä¸­è®¿é—®**

#### 3.2 pageAction åœ°å€æ å³ä¾§

`pageAction`å’Œ`browserAction`äºŒé€‰ä¸€é…ç½®å³å¯ï¼Œ`pageAction`ä¸`browserAciton`çš„åŒºåˆ«æ˜¯

- `pageAction`ï¼šåœ¨ç‰¹å®šé¡µé¢é€šè¿‡ä»£ç æ¿€æ´»æ—¶æ‰æ˜¾ç¤º
- `browserAction`ï¼šä¸€ç›´æ˜¾ç¤ºåœ¨å³ä¸Šè§’

åœ¨ chrome 58 ç‰ˆæœ¬ä¹‹å‰è¿™ä¸¤ä¸ªæ˜¯åˆ†å¼€çš„ï¼Œå½“æ—¶`pageAction`æ˜¯æ˜¾ç¤ºåœ¨åœ°å€æ åé¢çš„ï¼Œåƒä¸‹é¢è¿™æ ·

![image-20220118162804893](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220118162804893.png?x-oss-process=image/resize,w_400,m_lfit) 

åœ¨ 58 ç‰ˆæœ¬ä¹‹ååˆ™æ˜¯å’Œ`browserAction`ä¸€æ ·éƒ½åœ¨å³ä¸Šè§’äº†ï¼ŒåŒºåˆ«æ˜¯æœ‰æ¿€æ´»ï¼ˆç°è‰²ï¼‰ï¼Œæœªæ¿€æ´»ï¼ˆæ­£å¸¸ï¼‰ä¸¤ç§çŠ¶æ€ã€‚

**æ¿€æ´»ä¸æœªæ¿€æ´»çš„åŒºåˆ«ä»…ä»…æ˜¯å·¦é”®ç‚¹å‡»æ˜¯å¦ä¼šå¼¹å‡º option é€‰æ‹©å’Œå±•ä¸å±•ç¤º badgeï¼Œæ³¨å…¥çš„ä»£ç é€»è¾‘è¿˜æ˜¯ä¼šæ­£å¸¸è¿è¡Œ ** 

![image-20220118163048431](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220118163048431.png?x-oss-process=image/resize,w_400,m_lfit) 

**å¦‚ä½•æ¿€æ´»(éœ€è¦ declarativeContent æƒé™å£°æ˜)**

```js
chrome.pageAction.show(tabId); // æ˜¾ç¤ºå›¾æ ‡
chrome.pageAction.hide(tabId); // éšè—å›¾æ ‡
```

```js
// åªåœ¨ç™¾åº¦æ‰“å¼€æ—¶æ‰å‘ˆç°æ¿€æ´»çŠ¶æ€
// background.js

// é¦–æ¬¡å®‰è£…æ‰©å±•ç¨‹åºã€æ‰©å±•ç¨‹åºæ›´æ–°åˆ°æ–°ç‰ˆæœ¬ä»¥åŠ Chrome æ›´æ–°åˆ°æ–°ç‰ˆæœ¬æ—¶è§¦å‘ã€‚
chrome.runtime.onInstalled.addListener(function () {
  // declartiveContent è¯»å–é¡µé¢å†…å®¹ä¸”ä¸éœ€è¦è¯·æ±‚æƒé™
  // é¡µé¢æ”¹å˜äº‹ä»¶æ—¶ æ³¨å†Œå£°æ˜ç›¸å…³çš„è§„åˆ™
  chrome.declarativeContent.onPageChanged.removeRules(undefined, function () {
    chrome.declarativeContent.onPageChanged.addRules([
      {
        conditions: [
          new chrome.declarativeContent.PageStateMatcher({
            pageUrl: { urlContains: "baidu.com" },
          }),
        ],
        actions: [new chrome.declarativeContent.ShowPageAction()],
      },
    ]);
  });
});
```

#### 3.3 æµè§ˆå™¨å³é”®èœå•ï¼ˆcontextMenusï¼‰

æ‰©å±•å¯ä»¥ç»™æµè§ˆå™¨å³é”®å¢åŠ èœå•ï¼ˆéœ€è¦ contextMenus æƒé™å£°æ˜ï¼‰ã€‚

![image-20220118185749442](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220118185749442.png?x-oss-process=image/resize,w_400,m_lfit) 

```js
chrome.contextMenus.create({
	type: 'normal'ï¼Œ // ç±»å‹ï¼Œå¯é€‰ï¼š["normal", "checkbox", "radio", "separator"]ï¼Œé»˜è®¤ normal
	title: 'èœå•çš„åå­—', // æ˜¾ç¤ºçš„æ–‡å­—ï¼Œé™¤éä¸ºâ€œseparatorâ€ç±»å‹å¦åˆ™æ­¤å‚æ•°å¿…éœ€ï¼Œå¦‚æœç±»å‹ä¸ºâ€œselectionâ€ï¼Œå¯ä»¥ä½¿ç”¨%sæ˜¾ç¤ºé€‰å®šçš„æ–‡æœ¬
	contexts: ['page'], // ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¯é€‰ï¼š["all", "page", "frame", "selection", "link", "editable", "image", "video", "audio"]ï¼Œé»˜è®¤page
	onclick: function(e){}, // å•å‡»æ—¶è§¦å‘çš„æ–¹æ³•
	parentId: 1, // å³é”®èœå•é¡¹çš„çˆ¶èœå•é¡¹IDã€‚æŒ‡å®šçˆ¶èœå•é¡¹å°†ä¼šä½¿æ­¤èœå•é¡¹æˆä¸ºçˆ¶èœå•é¡¹çš„å­èœå•
	documentUrlPatterns: 'https://*.baidu.com/*' // åªåœ¨æŸäº›é¡µé¢æ˜¾ç¤ºæ­¤å³é”®èœå•
});
// åˆ é™¤æŸä¸€ä¸ªèœå•é¡¹
chrome.contextMenus.remove(menuItemId)ï¼›
// åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰å³é”®èœå•
chrome.contextMenus.removeAll();
// æ›´æ–°æŸä¸€ä¸ªèœå•é¡¹
chrome.contextMenus.update(menuItemId, updateProperties);
```

**å‚æ•°è¯´æ˜** 

- `type`
  - checkbox/radioï¼šå³é”®èœå•ä¼šå°†æ‰©å±•ååŠ å…¥èœå•ä¸­ï¼Œå¹¶ä¸”ä¼šæœ‰ä¸€ä¸ªå¯é€‰çš„å­èœå•æ˜¯è¿™é‡Œçš„ title
  - separatorï¼šåªæ˜¯åœ¨å³é”®èœå•ä¸­åŠ å…¥åˆ†éš”çº¿
- `contexts`
  - pageï¼šæ•´ä¸ªé¡µé¢ä¸Šå³é”®ç‚¹å‡»è§¦å‘ï¼Œä»¥æ•´ä¸ªé¡µé¢ä¸ºä¸Šä¸‹æ–‡
  - selectionï¼šå½“æœ‰æ‹–è“é€‰ä¸­æ—¶å³é”®èœå•ä¸­æ‰ä¼šåŒ…å«ï¼Œä»¥æ‹–è“é€‰ä¸­çš„åŒºåŸŸä¸ºä¸Šä¸‹æ–‡
  - ...å…¶ä»–åŒç†
- `onClick`ï¼šç‚¹å‡»äº‹ä»¶çš„å›è°ƒï¼Œ**æºå¸¦é»˜è®¤å‚æ•°ä¸ºå½“å‰ä¸Šä¸‹æ–‡**
- `parentId`ï¼šçˆ¶èœå•æŒ‰é’® idï¼Œæœªæ‰¾åˆ°çˆ¶èœå•æ—¶ä¸å±•ç¤ºè¯¥èœå•

ç¤ºä¾‹ï¼šï¼ˆå³é”® google æœç´¢èœå•ï¼‰

```js
function createMenu() {
  chrome.contextMenus.create({
    title: "Google æœç´¢",
    contexts: ['selection'],
    onclick: function (e) {
      chrome.tabs.create({url: 'https://www.google.com/search?q=' + encodeURIComponent(e.selectionText)}) // e.selectionText é€‰ä¸­çš„æ–‡æœ¬
    }
  });
}
```

å³é”®èœå•å®Œæ•´æ–‡æ¡£ï¼šhttps://developer.chrome.com/docs/extensions/reference/contextMenus/

#### 3.4 é¡µé¢è¦†ç›– chrome_url_overrides

é€šè¿‡é…ç½®`chrome_url_overrides`é€‰é¡¹å¯ä»¥å¯¹é»˜è®¤çš„é¡µé¢è¿›è¡Œè¦†ç›–ï¼Œä¸€å…±å¯ä»¥è¦†ç›–ä¸‰ç±»é¡µé¢

1. æ–°æ ‡ç­¾é¡µ - `newtab`
2. ä¹¦ç­¾é¡µ - `bookmarks`
3. å†å²è®°å½•ä¹Ÿ - `history`

åŒæ—¶ä¹Ÿè¦æ³¨æ„å‡ ä¸ªé—®é¢˜

1. ä¸€ä¸ªæ‰©å±•åªèƒ½åŒæ—¶æ›¿ä»£ä¸€ä¸ªé¡µé¢ï¼ˆé…ç½®å¤šä¸ªæ—¶åŠ è½½æ’ä»¶å°±ä¼šæŠ¥é”™ï¼‰
2. ä¸èƒ½æ›¿ä»£éšèº«çª—å£çš„æ ‡ç­¾é¡µ
3. ç½‘é¡µæœ€å¥½è®¾ç½® titleï¼Œå¦åˆ™ç”¨æˆ·çœ‹ä¸åˆ° title ä¼šä¸çŸ¥é“é¡µé¢æ˜¯ä»€ä¹ˆï¼Œä¸€ç‰‡ç©ºç™½ï¼ˆæœªè®¾ç½®æ—¶å±•ç¤ºå¦‚ï¼šchrome://newtabï¼‰

```json
{
  "chrome_url_overrides"ï¼š {
  	"newtab": "newtab.html"
	}
}
```

æ›¿æ¢æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220118201003406](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220118201003406.png?x-oss-process=image/resize,w_600,m_lfit)  

#### 3.5 å¼€å‘è€…å·¥å…· devtools

å¼€å‘è€…å·¥å…·å³æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„è°ƒè¯•å·¥å…·ï¼Œè€Œé€šè¿‡æ‰©å±•çš„é…ç½®ï¼Œå¯ä»¥å‘å¼€å‘è€…å·¥å…·ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„é¢æ¿ã€‚ï¼ˆå°±åƒ vue çš„è°ƒè¯•å·¥å…·ä¸€æ ·ï¼‰

é…ç½®æ–¹æ³•ï¼Œåœ¨æ¸…å•ä¸­å£°æ˜é…ç½®é¡¹

```json
{
  "devtools_page": "devtools.html" // åªèƒ½æ˜¯ html æ–‡ä»¶
}
```

è¿™é‡Œé…ç½®çš„å€¼åªèƒ½æ˜¯ä¸€ä¸ª html æ–‡ä»¶ï¼Œ**ä½†æ˜¯é¢æ¿é‡Œçš„å†…å®¹ä¸æ˜¯ä»¥è¿™ä¸ª html æ–‡ä»¶çš„å†…å®¹ä¸ºå‡†çš„ã€‚è¿™é‡Œé…ç½®çš„ html é¡µé¢åªå……å½“ä¸€ä¸ª js å¼•å…¥çš„ä½œç”¨**ã€‚ï¼ˆGoogle è¿™ä¹ˆè§„å®šçš„ï¼Œä¸æ¸…é™¤åŸå› ï¼‰

é…ç½®å¥½ devtools çš„é¡µé¢åï¼Œå³å¯åœ¨å¼•å…¥çš„ js ä¸­çœŸæ­£çš„åˆ›å»ºæˆ‘ä»¬çš„ devtool é¢æ¿ã€‚ä¹Ÿå¯ä»¥å®šä¹‰ä¾§è¾¹æ ï¼ˆsidebarï¼Œ åªèƒ½åœ¨ Elements é¢æ¿ä¸­ä½¿ç”¨ï¼‰

```js
// åˆ›å»º devtools é¢æ¿
chrome.devtools.panels.create(
  "demo1Panel", // é¢æ¿å
  "img/icon.png", // å›¾ç‰‡ã€‚æš‚æ—¶ä¸çŸ¥é“ä½œç”¨ï¼Ÿ
  "demo1Panel.html", // 
  function (panel) {
    console.log("Hello devtools"); // åˆ›å»ºæˆåŠŸåçš„å›è°ƒå‡½æ•°ï¼ˆè¿™ä¸ª console.log åº”è¯¥çœ‹ä¸åˆ°ï¼Œå› ä¸ºä»–æ˜¯åœ¨å¼€å‘è€…å·¥å…·æ‰“å¼€çš„ç¬é—´åˆ›å»ºçš„ï¼Œç”¨ alert çš„è¯å°±å¯ä»¥è§‚å¯Ÿåˆ°ï¼‰
  }
);

// åˆ›å»º devtools ä¾§è¾¹æ ï¼ˆæ³¨æ„è¿™é‡Œè¿˜æœ‰ä¸ª elements å‚æ•°ï¼‰
chrome.devtools.panels.elements.createSidebarPane("demo1Sidebar", function (sidebar) {
  // sidebar.setPage('../sidebar.html'); // æŒ‡å®šåŠ è½½æŸä¸ªé¡µé¢
  sidebar.setExpression('document.querySelectorAll("img")', "All Images"); // é€šè¿‡è¡¨è¾¾å¼æ¥æŒ‡å®š
  //sidebar.setObject({a: 1, b: 'Hello World!'}); // ç›´æ¥è®¾ç½®æ˜¾ç¤ºæŸä¸ªå¯¹è±¡
});
```

*é¢æ¿* 

![image-20220119144231650](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220119144231650.png?x-oss-process=image/resize,w_800,m_lfit) 

*åœ¨ä¾§è¾¹æ ä¸­* 

![image-20220119144146146](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220119144146146.png?x-oss-process=image/resize,w_600,m_lfit) 

**ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ devtools** 

devtools å…·æœ‰ä¸€ç»„ç‰¹æœ‰çš„`Devtools API`ï¼Œåªæœ‰ä»–è‡ªå·±æœ‰æƒé™è°ƒç”¨ï¼Œèƒ½å¸®æˆ‘ä»¬å®ç°æ›´å¤šçš„åŠŸèƒ½ã€‚

APIï¼š

- `chrome.devtools.panels`ï¼šé¢æ¿ç›¸å…³ï¼›
- `chrome.devtools.inspectedWindow`ï¼šè·å–è¢«å®¡æŸ¥çª—å£çš„æœ‰å…³ä¿¡æ¯ï¼›
- `chrome.devtools.network`ï¼šè·å–æœ‰å…³ç½‘ç»œè¯·æ±‚çš„ä¿¡æ¯ï¼›

content-scripts - background - devtools ä¹‹é—´æ˜¯å¯ä»¥äº’ç›¸é€šä¿¡çš„

![image-20220119142744195](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220119142744195.png?x-oss-process=image/resize,w_800,m_lfit) 

å¦‚æœè¦å®ç° devtools å’Œ background é€šä¿¡ï¼ŒDevTools é¡µé¢ä¸èƒ½ç›´æ¥è°ƒç”¨[`chrome.scripting.executeScript`](https://developer.chrome.com/docs/extensions/scripting#method-executeScript)ã€‚è¦ä» DevTools é¡µé¢æ³¨å…¥å†…å®¹è„šæœ¬ï¼Œå¿…é¡»ä½¿ç”¨è¯¥[`chrome.devtools.inspectedWindow.tabId`](https://developer.chrome.com/docs/extensions/mv3/devtools.inspectedWindow#property-tabId)å±æ€§æ£€ç´¢å·²æ£€æŸ¥çª—å£é€‰é¡¹å¡çš„ IDï¼Œå¹¶å‘åå°é¡µé¢å‘é€æ¶ˆæ¯ã€‚ä»åå°é¡µé¢è°ƒç”¨`executeScript`æ³¨å…¥è„šæœ¬ã€‚

ä¸€ä¸ªæ™®é€šçš„`inspectedWindow`è°ƒç”¨ç¤ºä¾‹ï¼š

```js
// demo1Panel.html
<button id="look20">æŸ¥çœ‹ç¬¬ 20 è¡Œä»£ç </button>

// demo1Panel.js
const btn20 = document.getElementById("look20");

btn20.addEventListener('click', () => {
  chrome.devtools.inspectedWindow.eval('window.location.href', (result, isException) => {
    chrome.devtools.panels.openResource(result, 20, function() {
      console.log('æ‰“å¼€æˆåŠŸ')
    })
  })
})
```

**devtools è°ƒè¯•æ³¨æ„** 

ç”±äº devtools æœ¬èº«å°±æ˜¯å¼€å‘è€…å·¥å…·é¡µé¢ï¼Œæ‰€ä»¥å‡ ä¹æ²¡åŠæ³•ç›´æ¥è°ƒè¯•ä»–ã€‚åªèƒ½å¼€å‘æ—¶æ³¨æ„ï¼Œéœ€è¦ç‰¹åˆ«å°å¿ƒã€‚

#### 3.6 option é€‰é¡¹é¡µ

options é€‰é¡¹é¡µé¢ï¼Œå¯ä»¥é€šè¿‡å³å‡»æ‰©å±•çš„å›¾æ ‡ -> é€‰é¡¹ è¿›å…¥

```json
{
  "options_ui": {
    "page": "options.html",
    "open_in_tab": false // æ˜¯å¦åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ã€‚é»˜è®¤ falseï¼Œä¼šåœ¨ chrome æ‰©å±•é¡µé¢æ‰“å¼€
  },
}
```

![image-20220119152911941](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220119152911941.png?x-oss-process=image/resize,w_1000,m_lfit)

é€‰é¡¹é…ç½®å¯ä»¥ä½¿ç”¨ google çš„ `storage.sync` API è·¨è®¾å¤‡ä¿å­˜

```js
// å­˜å‚¨å€¼
chrome.storage.sync.set({
  favoriteColor: color,
  likesColor: likesColor
}, function() {
  // æˆåŠŸçš„å›è°ƒ
  var status = document.getElementById('status');
  status.textContent = 'Options saved.';
  setTimeout(function() {
    status.textContent = '';
  }, 750);
});

// è·å–å€¼
chrome.storage.sync.get({
  favoriteColor: 'red', // è¿˜å¯ä»¥èµ‹é»˜è®¤å€¼
  likesColor: true
}, function(items) {
  document.getElementById('color').value = items.favoriteColor;
  document.getElementById('like').checked = items.likesColor;
});
```

#### 3.7 omnibox æœç´¢æ å»ºè®®

omibox åœ¨å¯ä»¥åœ¨æœç´¢æ ä¸­ç»™ç”¨æˆ·æä¾›æœç´¢å»ºè®®

```json
{
  "omnibox": {
    "keyword": "go" // é€šè¿‡å…³é”®å­— go è§¦å‘ï¼Œè¾“å…¥åæŒ‰ tab æˆ–æ‰‹åŠ¨é€‰æ‹©å³å¯è¿›å…¥æ’ä»¶å»ºè®®çš„è¾“å…¥æ 
  }
}
```

![image-20220119160743187](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220119160743187.png?x-oss-process=image/resize,w_800,m_lfit)

å®ç°çš„æ•ˆæœå¦‚ä¸Š

```js
// background.js è¿™ç§å¸¸é©»çš„åŠŸèƒ½å¾ˆæ˜æ˜¾æ˜¯æ”¾åœ¨ background.js ä¸­

/**
 * è¾“å…¥æ—¶è§¦å‘
 * @param { string } text ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
 * @param { function } suggest å»ºè®®æ˜¾ç¤ºå›è°ƒ
 */
chrome.omnibox.onInputChanged.addListener((text, suggest) => {
  if (!text) return;
  if (text === "jj") {
    // content: é€‰ä¸­æœç´¢å»ºè®®æ—¶å¡«å…¥åœ°å€æ çš„å€¼ description: æœç´¢å»ºè®®å±•ç¤ºçš„æ–‡æœ¬ éƒ½æ˜¯å¿…å¡«çš„
    suggest([{ content: "https://juejin.im/", description: "è®¿é—®æ˜é‡‘" }]);
  } else {
    suggest([
      {
        content: "https://www.google.com/search?q=" + encodeURIComponent(text),
        description: "Google æœç´¢" + text,
      },
    ]);
  }
});
// é€‰æ‹©æ—¶è§¦å‘äº‹ä»¶
chrome.omnibox.onInputEntered.addListener((text) => {
  if (!text) return;
  let href = "";
  // å¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œç„¶åç”¨æˆ·åˆå»é€‰æ‹©äº† "è®¿é—®æ˜é‡‘" é‚£ä¹ˆä¼šæŠŠæ˜é‡‘çš„åœ°å€å¡«åˆ°åœ°å€æ ä¸­ï¼Œç„¶åæ˜é‡‘çš„åœ°å€ !== "jj" å¯¼è‡´ä¼šç”¨ google å»æœç´¢æ˜é‡‘çš„åœ°å€
  if (text === "jj" || text === "https://juejin.im/") {
    href = "https://juejin.im/";
  } else {
    href = "https://www.google.com/search?q=" + encodeURIComponent(text);
  }
  openUrlCurrentTab(href);
});

function openUrlCurrentTab(href) {
  getCurrentTabId((tabId) => chrome.tabs.update(tabId, { url: href }));
}

function getCurrentTabId(cb) {
  chrome.tabs.query(
    {
      active: true,
      currentWindow: true, // è·å–å½“å‰ tab æ çš„ id
    },
    function (tabs) {
      if (cb) cb.call(tabs.length ? tabs[0] : null);
    }
  );
}
```

#### 3.9 æ¡Œé¢é€šçŸ¥ (notifications)

æ‰©å±•æä¾›äº†`chrome.notifications`æ–¹æ³•ä»¥åˆ›å»ºé€šçŸ¥ï¼Œå’Œæµè§ˆå™¨åœ¨ h5 ä¸­æä¾›çš„`Notification`ç±»ä¼¼ã€‚éœ€è¦åœ¨`permissions` ä¸­å£°æ˜`notifications`æƒé™

```js
chrome.notifications.create(null, {
  type: "basic",
  iconUrl: "img/icon.png", // è¿™å‡ é¡¹éƒ½æ˜¯å¿…å¡«çš„
  title: "é€šçŸ¥æ ‡é¢˜1",
  message: " Google æœç´¢äº†ä¸€ä¸‹",
  buttons: [{ title: "æŒ‰é’®1", iconUrl: "img/icon.png" }]
}, (id) => { console.log(id) });


//ç‚¹å‡»è‡ªå®šä¹‰çš„æŒ‰é’®äº‹ä»¶
chrome.notifications.onButtonClicked.addListener((notificationId, index) => {
  console.log(notificationId, index); //å½“å‰é€šçŸ¥çš„IDå’Œå½“å‰ç‚¹å‡»æŒ‰é’®çš„index
});
```

type æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

- basicï¼šåŸºæœ¬çš„æ–‡å­—é€šçŸ¥
- imageï¼šå›¾ç‰‡é€šçŸ¥ï¼Œéœ€è¦é…ç½® imageUrlï¼Œåœ¨ mac ä¸Šä¸å¯è§
- listï¼šé€šçŸ¥åˆ—è¡¨ï¼Œéœ€è¦é…ç½® items : Array<[title: String, message: String]>ï¼Œåœ¨ mac ä¸Šåªèƒ½çœ‹åˆ°ç¬¬ä¸€æ¡
- preogessï¼šè¿›åº¦é€šçŸ¥ï¼ˆæ²¡ç”¨è¿‡ï¼‰

## å¼€å‘æ³¨æ„äº‹é¡¹

- **chrome åŠ è½½åçš„é”™è¯¯ä¿®æ”¹åé‡æ–°åŠ è½½ä¹Ÿä¸ä¼šè‡ªåŠ¨æ¸…é™¤ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å…¨éƒ¨æ¸…é™¤**ã€‚ğŸ˜­ä¸æ˜¯é”™è¯¯æ²¡å¤„ç†å¥½

![image-20220117204721229](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220117204721229.png?x-oss-process=image/resize,w_300,m_lfit) 

- default_locale é…ç½®æ—¶è¦æ±‚ä¸€ä¸ªåŒ…å«è¯­è¨€æè¿°æ–‡ä»¶çš„æ–‡ä»¶å¤¹

![image-20220117205255367](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220117205255367.png?x-oss-process=image/resize,w_300,m_lfit) 

- **`unrecognized permissions`**  é”™è¯¯ï¼å¯èƒ½æ˜¯æƒé™åˆ—è¡¨å†…æŸä¸€é¡¹å¡«é”™äº†å¯¼è‡´çš„
- `Cannot read properties`ç±»å‹çš„é”™è¯¯ï¼ä¸€èˆ¬æ˜¯æœªåœ¨æƒé™åˆ—è¡¨ä¸­å£°æ˜æƒé™å¯¼è‡´çš„

![image-20220118185129549](https://liaoyk-markdown.oss-cn-hangzhou.aliyuncs.com/markdownImg/image-20220118185129549.png?x-oss-process=image/resize,w_300,m_lfit) 

- **åœ¨ popup / background åå°é¡µé¢ä½¿ç”¨æµè§ˆå™¨çš„ API æ—¶ï¼Œè¦æ³¨æ„å…¶ä¸Šä¸‹æ–‡ç¯å¢ƒä¸æ˜¯å½“å‰é¡µé¢ï¼Œè€Œæ˜¯æ‰©å±•çš„é¡µé¢ã€‚**å¦‚ popup.js å®é™…è¿è¡Œåœ¨`chrome-extension://[extensionId]/popup.html`

## å‚è€ƒæ–‡æ¡£

å¼€å‘å…¨æ”»ç•¥ï¼šhttps://wizardforcel.gitbooks.io/chrome-doc/content/1.html

å¼€å‘æ–‡æ¡£ï¼ˆéå®˜æ–¹ï¼‰ï¼šhttps://wizardforcel.gitbooks.io/chrome-doc/content/1.html

å¼€å‘æ–‡æ¡£ï¼ˆfirefox å®˜æ–¹ï¼Œå’Œ chrome åŸºæœ¬ç›¸åŒï¼‰ï¼šhttps://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions

Chrome æ‰©å±• APIï¼šhttps://developer.chrome.com/docs/extensions/reference/

Chrome permission æƒé™æ–‡æ¡£ï¼šhttps://developer.chrome.com/docs/extensions/mv2/declare_permissions/#manifest