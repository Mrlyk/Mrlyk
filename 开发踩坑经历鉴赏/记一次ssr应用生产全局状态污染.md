# 记一次ssr应用生产全局状态污染

工作中总会遇到各种稀奇古怪的问题，这次这个问题耗费整整两天才排查出来，坑，巨坑！给大家引以为戒！

## 问题描述

**现象：**用户登录时，**偶发**的出现登录后登录信息不展示问题！

**问题来源：**

用户：小xxx啊，客户反应我们系统老是登录不上去啊，你看看？

我：还有这种事？我看看。登录ing...没问题啊老板。

老板：我看看，哎好像确实没问题，我再去和客户确认下。

一段时间后...

老板：小xxx啊，客户还是反应有问题啊，你再看看。

我：不可能啊，我再看看！（内心：nmd 什么鬼，肯定是客户电脑有问题，浏览器有问题，我这不好好的。哎老板发话了那就先看着吧！）

开发最怕遇到什么问题？**偶发**问题。没有规律的问题是最难的问题T T！但是打工人是不能退却的，一退就是房贷车贷老婆孩子。

## 问题排查过程

要解决一个问题，我们首先要做的是定位这个问题。怎么做？当然是先复现一下这个问题，看看是哪个交互操作带来了这个bug。

复现问题->查看业务逻辑->寻找逻辑漏洞->加临时日志->定位问题原因

#### 复现问题

1. 在本地复现，失败
2. 在测试环境复现，失败
3. 在灰度环境复现，失败
4. 在生产环境复现，偶现

本地不能复现，让本就困难的问题定位更加雪上加霜！

## 解决问题

1. 项目是一个 vue ssr 项目，基于 vuex 做数据状态管理，问题的现象是用户点击登陆跳转后有一定概率直接登出回到登陆页，在生产环境上尤其明显，在测试环境则很难出现。
2. 按照一贯解决问题的思路要解决问题先要定位问题，定位问题最快的方式是先稳定的把问题复现出来再去看对应部分的代码，但是生产环境不能乱登，测试环境很难出现，几乎无法复现。
3. 所以转为第二个思路，根据现象找直接原因，现象是用户登陆自动跳转到个人中心页后立刻又登出了，要么是全局的路由守卫拦截的有问题，要么是服务端的入口登陆状态判断有问题，只有这两个地方有自动跳转到登陆页的逻辑。排查后，发现都没有问题，逻辑无误。因为这里的判断条件都是依据 vuex 中的数据状态的，所以我接着就看了一下项目中 vuex 是如何实例化和传递的。
4. 查看vuex实例化的代码发现这里为了能在项目的任何地方获取到同一个 vuex 实例，实例化vuex的时候使用了单例模式。我一开始认为就是这个单例的问题，在服务器上大家都是一个环境，所有的请求打过来都是使用的这唯一一个实例导致状态污染，前一个登录信息被后一个用户挤掉，但实际不是，这里有两个误导我的点：1）vuex 实例化这里的代码很久没改动了；2）我被告知这个问题是最近才发现的，所以我认为这里之前是没问题的。到这里常规思路就断了。
5. 那我就回到问题本身，现象是在生产大概率出现，但是在测试环境却几乎无法复现，两者有什么区别呢？首先两者的前端代码肯定是一模一样的。那就只有服务器环境和用户量的区别。登陆部分的逻辑并不依赖环境变量，所以这个可以排除，还有用户量的区别，用户量会对这个产生影响？其实这里已经接近问题了，但是我一开始方向想错了认为可能是服务不稳定导致的。但是监控显示服务一直没挂过，内存占用也正常。百思不得其解之后我开始和同事探讨这个问题可能的原因，最后认为可能是 vuex 本身在 ssr 项目中可能有问题。所以我接着去看了一下 vuex 的源码存储数据的实现，也没发现什么问题。
6. 最终实在没办法，我临时写了个日志脚本，专门抓登录前后的vuex实例信息作对比。终于发现了重要的线索，直接原因确实是和用户多了有关，在日志上显示，当几个用户同时登录时，前一个用户的登录信息在跳转后被后一个用户的存储逻辑置空了，导致前一个用户在跳转到个人中心页后在vuex中确实没有用户信息所以被登出了。
7. 直接原因找到了，那为什么会这样呢？存储用户信息的代码逻辑没问题也很久没动过了呀。这时候我去 vuex 的 issues 里面查了一下有没有其他人遇到过这样的问题，发现确实有。原因是在声明 vuex 模块中状态的时候没有通过函数函数返回变量，而是直接在 state 上通过对象声明。这是 vue ssr 和 vue 普通项目中使用 vuex 很大的一点不同，在 vue ssr 项目中状态声明必须放在一个函数中返回，防止状态互相污染。然后我看了一下我项目中的 vuex 状态声明，一个、两个声明的都没问题，但是只有用户登录信息这个模块，声明有问题没有使用函数。至此问题解决。。

问题解决后一看真的是个很低级的错误，但是却花了我一整天时间去找原因。为此我也得到了一些教训。

#### 排查流程

定位问题（通过复现的方式）-> 找直接原因（分析代码逻辑） -> 重新分析问题现象 -> 和同事一起探讨 -> 怀疑第三方工具并求证 -> 实践通过专门的日志分析 -> 官方工具上搜索同样的问题 -> 解决问题 -> 总结并记录问题

## 得到的教训

小心求证，大胆实践。有时候获得的外部信息不一定是对的，要自己实践看看。因为我这里获取到一个信息是这边很久没改过，之前也没问题所以我没有去确认是不是以前真的没问题。（这里最后确认发现是因为项目之前一直未正式上线都在测试环境跑，所以没发现这个问题，这个问题一定要是多个用户同时登录才会触发，所以一直都是有问题的）

